<!DOCTYPE html>
<html lang="zh-TW" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é€šçŸ¥ä¸­å¿ƒ - ShakeMate</title>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=LXGW+Marker+Gothic&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
    <link rel="stylesheet" href="/css/headerStyle.css">
    
    <style>
        html {
            font-size: 62.5%;
            font-family: "Noto Sans TC", sans-serif;
            /* ä½¿ç”¨å°ˆæ¡ˆè¦ç¯„çš„èƒŒæ™¯è‰² */
            background: linear-gradient(185deg, #DCFF61 0%, #DCFF61 55%, #2EC4B6 55%, #2EC4B6 100%);
        }
        
        body {
            margin: 0;
            min-height: 100vh;
            font-family: "Noto Sans TC", sans-serif;
        }
        .bg {
            position: relative;
            min-height: 100vh;
            z-index: 0;
            background: linear-gradient(185deg, #DCFF61 0%, #DCFF61 55%, #2EC4B6 55%, #2EC4B6 100%);
            overflow: hidden;
        }
        .bg::before {
            content: "";
            position: absolute;
            inset: 0;
            background: rgba(255, 255, 255, 0.25);
            z-index: 0;
            pointer-events: none;
        }
        .hero-section {
            min-height: 57rem;
            margin-top: 10rem;
            display: flex;
            justify-content: center;
            position: relative;
            background: transparent;
            z-index: 1;
        }
        .hero-section::before { display: none; }

        /* ä¸»è¦å†…å®¹å®¹å™¨ï¼Œæ”¾å®½ */
        .main-content {
            width: 100%;
            max-width: 80rem; /* å†æ¬¡è°ƒæ•´å®½åº¦ */
            padding: 0 2rem;  /* æ·»åŠ æ°´å¹³å†…è¾¹è· */
        }

        /* é€šçŸ¥åˆ—è¡¨å®¹å™¨ */
        .notification-container {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 1.5rem;
            padding: 3rem; /* å¢åŠ å†…è¾¹è·ï¼Œè®©å†…å®¹æ›´èˆ’å±• */
            box-shadow: 0 0.4rem 1.5rem rgba(0, 0, 0, 0.1);
            width: 100%;
        }
        
        /* é¡µé¢æ ‡é¢˜ */
        .notification-page-title {
            font-size: 2.4rem;
            color: #333;
            margin-bottom: 2rem;
            padding-bottom: 1rem;
            border-bottom: 0.2rem solid #f0f0f0;
            font-family: "LXGW Marker Gothic", sans-serif;
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: relative;
        }

        .notification-page-title .title-text {
            position: absolute;
            left: 50%;
            transform: translateX(-50%);
            text-align: center;
        }

        .notification-settings-btn {
            font-size: 1.6rem;
            color: #555;
            text-decoration: none;
            padding: 0.8rem 1.2rem;
            border-radius: 0.8rem;
            background-color: #f0f0f0;
            transition: background-color 0.3s;
        }
        
        .notification-settings-btn:hover {
            background-color: #e0e0e0;
        }

        /* é€šçŸ¥åˆ—è¡¨ä¸»ä½“ */
        .notification-list-body {
            background: transparent;
            border-radius: 1.5rem;
            padding: 2rem;
        }

        /* é¡µé¢ä¸Šçš„é€šçŸ¥é¡¹ï¼Œä½¿ç”¨ä¸åŒäºä¸‹æ‹‰èœå•çš„ç±»å */
        .page-notification-item {
            background: #ffffff; /* ä¿æŒåŸºæœ¬ç™½è‰²èƒŒæ™¯ */
            border-radius: 1.2rem; /* å¢åŠ åœ†è§’ */
            padding: 2rem; /* å¢åŠ å†…è¾¹è· */
            margin-bottom: 1.8rem; /* å¢åŠ é¡¹é—´è· */
            box-shadow: 0 0.4rem 2rem rgba(0,0,0,0.08); /* è°ƒæ•´é˜´å½± */
            display: flex;
            align-items: flex-start;
            gap: 1.5rem;
            transition: transform 0.3s, box-shadow 0.3s;
            border: none; /* ç§»é™¤æ—§è¾¹æ¡† */
            border-left: 0.6rem solid #2EC4B6; /* é»˜è®¤ä½¿ç”¨ä¸»é¢˜è‰²ä½œä¸ºå·¦è¾¹æ¡† */
        }

        .page-notification-item:hover {
            transform: translateY(-0.3rem) scale(1.02); /* å¢åŠ æ‚¬æµ®æ•ˆæœ */
            box-shadow: 0 0.6rem 2.5rem rgba(46, 196, 182, 0.2); /* æ‚¬æµ®æ—¶æ˜¾ç¤ºä¸»é¢˜è‰²é˜´å½± */
            background-color: #f8fefd;
        }

        .page-notification-item.unread {
            background: linear-gradient(135deg, #ffffff 0%, #f0fffd 100%); /* æœªè¯»é¡¹ä½¿ç”¨æ¸å˜èƒŒæ™¯ */
            border-left-color: #FF3B30; /* æœªè¯»é¡¹ä½¿ç”¨é†’ç›®çš„çº¢è‰²è¾¹æ¡† */
        }

        .page-notification-item .content-wrapper {
            flex: 1;
        }

        .page-notification-item .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }
        
        .page-notification-item .message {
            font-size: 1.5rem;
            color: #555;
            margin-bottom: 0.8rem;
        }

        .page-notification-item .time {
            font-size: 1.3rem;
            color: #999;
        }

        .page-notification-item .status {
            font-size: 1.3rem;
            padding: 0.4rem 0.8rem;
            border-radius: 0.4rem;
            background: #e8f5e9;
            color: #2e7d32;
        }

        .page-notification-item.unread .status {
            background: #e3f2fd;
            color: #1976d2;
        }

        @media (max-width: 768px) {
            .main-content {
                padding: 8rem 1rem 1rem;
            }
            
            .notification-container {
                margin-top: 1rem;
            }
        }

        .no-notifications {
            text-align: center;
            padding: 2rem;
            color: #666;
            font-size: 1.4rem;
        }
        
        .error-message {
            text-align: center;
            padding: 2rem;
            color: #d32f2f;
            font-size: 1.4rem;
        }
    </style>
</head>
<body>
    <div class="bg">
        <div th:replace="fragments/header1 :: header"></div>
        <div class="hero-section">
          <main class="main-content">
              <div class="notification-container">
                  <h1 class="notification-page-title">
                    <span class="title-text">é€šçŸ¥ä¸­å¿ƒ</span>
                    <div></div>
                    <a href="/notifications/preferences" class="notification-settings-btn"><i class="fa fa-cog"></i> é€šçŸ¥è¨­å®š</a>
                  </h1>
                  <div class="notification-list-body" id="notificationList">
                      <!-- é€šçŸ¥å…§å®¹å°‡é€šéJavaScriptå‹•æ…‹åŠ è¼‰ -->
                  </div>
              </div>
          </main>
        </div>
    </div>

    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="/js/header.js"></script>
    <script>
        $(document).ready(function() {
            // åŠ è½½é€šçŸ¥åˆ—è¡¨
            loadNotifications();
            
            // è®¾ç½®å…¨å±€å›è°ƒå‡½æ•°ï¼Œå½“å¯¼èˆªæ é€šçŸ¥çŠ¶æ€æ”¹å˜æ—¶è°ƒç”¨
            window.notificationStateChanged = function(notificationId) {
                console.log('æ”¶åˆ°é€šçŸ¥çŠ¶æ€æ”¹å˜äº‹ä»¶:', notificationId);
                // é‡æ–°åŠ è½½é€šçŸ¥åˆ—è¡¨
                loadNotifications();
            };
        });

        function loadNotifications() {
            $.ajax({
                url: '/notifications/api', // APIç«¯é»
                type: 'GET',
                data: { page: 0, size: 10 }, // ğŸ”§ ä¿®å¾©ï¼šé è¨­æ¯é 10ç­†
                success: function(response) {
                    const listElement = $('#notificationList');
                    if (response && response.content && response.content.length > 0) {
                        listElement.empty();
                        response.content.forEach(notification => {
                            const item = $(
                                `<div class="page-notification-item ${!notification.isRead ? 'unread' : ''}" data-id="${notification.notificationId}">
                                    <div class="content-wrapper">
                                        <div class="header">
                                            <h2 class="message">${notification.title}</h2>
                                            <span class="status">${notification.isRead ? 'å·²è®€' : 'æœªè®€'}</span>
                                        </div>
                                        <p class="message">${notification.message}</p>
                                        <p class="time">${formatTimeAgo(notification.sentTime)}</p>
                                    </div>
                                </div>`
                            );
                            // åªç»™æœªè¯»é¡¹åŠ ç‚¹å‡»äº‹ä»¶
                            if (!notification.isRead) {
                                item.css('cursor', 'pointer');
                                item.on('click', function() {
                                    markAsRead(notification.notificationId, item);
                                });
                            }
                            listElement.append(item);
                        });
                    } else {
                        listElement.html('<p class="no-notifications">ç›®å‰æ²’æœ‰ä»»ä½•é€šçŸ¥ã€‚</p>');
                    }
                },
                error: function() {
                    $('#notificationList').html('<p class="error-message">ç„¡æ³•è¼‰å…¥é€šçŸ¥ï¼Œè«‹ç¨å¾Œå†è©¦ã€‚</p>');
                }
            });
        }

        function markAsRead(notificationId, item) {
            // è°ƒç”¨header.jsä¸­çš„å…¨å±€å‡½æ•°ï¼Œä¿è¯è”åŠ¨æ›´æ–°
            if (window.markNotificationAsRead) {
                // ä½¿ç”¨å…¨å±€å‡½æ•°å¤„ç†æ ‡è®°å·²è¯»
                window.markNotificationAsRead(notificationId);
                
                // æœ¬åœ°UIç«‹å³æ›´æ–°ï¼ˆé¿å…ç­‰å¾…APIå“åº”çš„å»¶è¿Ÿï¼‰
                item.removeClass('unread');
                item.find('.status').text('å·²è®€');
                item.off('click'); // ç§»é™¤ç‚¹å‡»äº‹ä»¶
                item.css('cursor', 'default');
            } else {
                // å¦‚æœå…¨å±€å‡½æ•°ä¸å¯ç”¨ï¼Œä½¿ç”¨æœ¬åœ°AJAXè°ƒç”¨ä½œä¸ºåå¤‡
                $.ajax({
                    url: `/notifications/api/${notificationId}/mark-read`,
                    type: 'POST',
                    contentType: 'application/json',
                    success: function() {
                        item.removeClass('unread');
                        item.find('.status').text('å·²è®€');
                        item.off('click');
                        item.css('cursor', 'default');
                        // å°è¯•åˆ·æ–°å¯¼èˆªæ æœªè¯»æ•°
                        if (window.loadUnreadCount) {
                            window.loadUnreadCount();
                        }
                    },
                    error: function() {
                        alert('æ¨™è¨˜é€šçŸ¥ç‚ºå·²è®€å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦ã€‚');
                    }
                });
            }
        }
        
        function formatTimeAgo(dateString) {
            if (!dateString) return '';
            const date = new Date(dateString);
            const now = new Date();
            const seconds = Math.floor((now - date) / 1000);

            let interval = seconds / 31536000;
            if (interval > 1) return Math.floor(interval) + " å¹´å‰";
            interval = seconds / 2592000;
            if (interval > 1) return Math.floor(interval) + " å€‹æœˆå‰";
            interval = seconds / 86400;
            if (interval > 1) return Math.floor(interval) + " å¤©å‰";
            interval = seconds / 3600;
            if (interval > 1) return Math.floor(interval) + " å°æ™‚å‰";
            interval = seconds / 60;
            if (interval > 1) return Math.floor(interval) + " åˆ†é˜å‰";
            return "å‰›å‰›";
        }
    </script>
</body>
</html>