<!DOCTYPE html>
<html lang="zh-TW" xmlns:th="http://www.thymeleaf.org">

<head>
    <meta charset="UTF-8" />
    <title>å®¢æœç³»çµ±</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />

    <!-- å­—é«”èˆ‡åœ–ç¤º -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=LXGW+Marker+Gothic&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">

    <style>
        /* â€”â€” å…¨ç«™åŸºç¤ â€”â€” */
        html {
            font-size: 62.5%;
            
        }

        body {
            margin: 0;
            padding: 0;
            font-family: "Noto Sans TC", sans-serif;
            background-color: #f8f9fa;
            height: 100vh;
            display: flex;
            flex-direction: column;
            background: linear-gradient(to bottom, #E7FF33, #17AB96);
        }

        .container {
            max-width: 120rem;
            width: 100%;
            margin: 0 auto;
            padding: 0 0 1rem;
            box-sizing: border-box;
            flex: 1;
            display: flex;
            flex-direction: column;
        }

        /* â€”â€” Header â€”â€” */
        .header {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 6.5rem;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 4rem 0 2rem;
            backdrop-filter: blur(10px);
            z-index: 1000;
        }

        .headerlogo img {
            height: 4.5rem;
        }

        .headernav {
            display: flex;
            align-items: center;
            gap: 4rem;
        }

        .mobilenav {
            display: none;
        }

        .hamburger {
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            width: 2.5rem;
            height: 1.8rem;
            cursor: pointer;
        }

        .hamburger span {
            height: .3rem;
            background: #333;
            border-radius: 3px;
        }

        .headerlist {
            display: flex;
            gap: 3rem;
            list-style: none;
            margin: 0;
            padding: 0;
        }

        .headeritem a {
            display: inline-block;
            font-size: 1.6rem;
            color: #555;
            text-decoration: none;
            transition: color .3s, transform .3s ease;
        }

        .headeritem a:hover {
            color: #17AB96;
            transform: translate(0.5rem, -0.5rem);
        }

        .headernav .member i,
        .fa-user {
            font-size: 2rem;
            color: #555;
            transition: color .3s;
        }

        .headernav .member i:hover,
        .fa-user:hover {
            color: #17AB96;
        }

        /* â€”â€” ä¸»è¦å…§å®¹ â€”â€” */
        .main-content {
            display: flex;
            flex: 1;
            margin-top: 6.5rem;
            gap: 2rem;
        }

        .sidebar {
            display: flex;
            flex-direction: column;
            flex: 0 0 25rem;
            /* å›ºå®šå¯¬åº¦ 250pxï¼Œé«˜åº¦ç”± main-content æ±ºå®š */
            background: #fff;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
            padding: 0;
            /* å…§éƒ¨é–“è·ï¼Œæ”¹æ”¾åˆ° list ä¸Š */
        }

        .category-list {
            color: gray;
            font-size: 1.6rem;
            align-items: stretch;
            display: flex;
            flex-direction: column;
            flex: 1;
            /* æ’æ»¿ sidebar */
            margin: 0;
            padding: 0;
        }

        .category-item {


            flex: 1;
            /* å¹³å‡åˆ†é…å¯ç”¨é«˜åº¦ */
            display: flex;
            /* å…§éƒ¨åš flex ç½®ä¸­ */
            align-items: center;
            /* å‚ç›´ç½®ä¸­ */
            justify-content: center;
            /* æ°´å¹³ç½®ä¸­ */
            padding: 0 1.5rem;
            /* å·¦å³å…§è· */
            border-bottom: 1px solid #d0d0d0;
            cursor: pointer;
            transition: background-color .2s;
        }

        .category-item:last-child {
            border-bottom: none;
            /* æœ€å¾Œä¸€ç­†ä¸ç”¨åº•ç·š */
        }

        .category-item:hover {
            background: #f0f7ff;
        }

        .category-item.active {
            background: #e3f2fd;
            font-weight: bold;
        }

        .chat-container {
            flex: 1;
            display: flex;
            flex-direction: column;
            background: #fff;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
            overflow: hidden;
        }

        /* â€”â€” æ¨™é¡Œèˆ‡ã€Œç„¡æ³•è§£æ±ºã€æŒ‰éˆ• â€”â€” */
        .title-input {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 1.5rem 2rem;
            background: orange;
            color: #fff;
        }

        .title-input h1 {
            font-family: "LXGW Marker Gothic", sans-serif;
            font-size: 3rem;
            margin: 0;
            color: #fff;
        }

        .title-input .add-question {
            background: #fff;
            color: gray;
            border: 2px solid #fff;
            border-radius: 2.5rem;
            padding: 0.8rem 1.5rem;
            font-size: 1.4rem;
            text-align: center;
            text-decoration: none;
            transition: opacity .2s;
        }
        
        .title-input{
        opacity: 0.8;
        }

         .add-question:hover {
        	background: #17AB96;
        	color: white;
        }

        /* â€”â€” æ‰“å­—æŒ‡ç¤º â€”â€” */
        .typing-indicator {
            display: none;
            padding: 1rem 2rem;
            background: #fff;
            border-radius: 1.5rem;
            align-self: flex-start;
            border: 1px solid #d0d0d0;
            margin: 1rem 2rem 0;
            display: flex;
            align-items: center;
            gap: .5rem;
        }

        .typing-indicator.hidden {
            display: none;
        }

        .typing-indicator.visible {
            display: flex;
        }

        .typing-bubble {
            width: .8rem;
            height: .8rem;
            border-radius: 50%;
            background: #6b8cae;
            animation: bubble 1s infinite alternate;
        }

        @keyframes bubble {
            from {
                opacity: .5;
                transform: translateY(0);
            }

            to {
                opacity: 1;
                transform: translateY(-5px);
            }
        }

        /* â€”â€” è¨Šæ¯å€ â€”â€” */
        .chat-messages {
            font-size: 1.6rem;
            flex: 1;
            padding: 2rem;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
        }

        .message {
            max-width: 80%;
            padding: .4rem 2.5rem 1.5rem;
            border-radius: 1.5rem;
            position: relative;
            line-height: 1.5;
        }

        .message-user {
            background: #e3f2fd;
            align-self: flex-end;
            border-bottom-right-radius: .5rem;
        }

        .message-bot {
            background: #fff;
            align-self: flex-start;
            border: 1px solid #d0d0d0;
            border-bottom-left-radius: .5rem;
        }

        .message-time {
            position: absolute;
            bottom: .5rem;
            right: 1.5rem;
            font-size: 1rem;
            color: #888;
        }

        /* â€”â€” è¼¸å…¥å€ â€”â€” */
        .chat-input-container {
            display: flex;
            gap: 1rem;
            padding: 1.5rem 2rem;
            border-top: 1px solid #d0d0d0;
            background: #fff;
        }

        .chat-input {
            flex: 1;
            padding: 1.2rem 1.5rem;
            font-size: 1.6rem;
            border: 1px solid #d0d0d0;
            border-radius: 2.5rem;
        }

        .send-button {
            background: #fff;
            color: orange;
            border: 2px solid gray;
            border-radius: 2.5rem;
            padding: 0 2rem;
            font-size: 1.6rem;
            cursor: pointer;
            transition: opacity .2s;
        }

        .send-button:hover {
        background: orange;
        color: white;
        }

        .feedback-button {
            background: none;
            /* å–æ¶ˆé è¨­åº•è‰² */
            border: none;
            /* å–æ¶ˆé‚Šæ¡† */
            padding: 0;
            /* å¦‚æœ‰éœ€è¦ä¹Ÿå¯ä»¥æŠŠå…§è·æ¸…æ‰ */
            cursor: pointer;
            /* ä¿ç•™æ‰‹å½¢æ¸¸æ¨™æç¤ºå¯é»æ“Š */
        }

        .feedback-button:focus {
            outline: none;
            /* å¦‚æœé‚„æƒ³å»æ‰ focus æ™‚çš„è™›ç·šæ¡† */
        }



        /* éŸ¿æ‡‰å¼ */
        @media (max-width: 768px) {
            .main-content {
                flex-direction: column;
            }

            .sidebar {
                width: 100%;
                margin-bottom: 1.5rem;
            }

            .message {
                max-width: 90%;
            }

            .mobilenav {
                display: flex;
                align-items: center;
                gap: 2rem;
            }

            .headernav {
                position: absolute;
                top: 6.5rem;
                right: 0;
                flex-direction: column;
                background: #fff;
                width: 100%;
                max-height: 0;
                overflow: hidden;
                transition: max-height .3s ease;
                padding: 0;
            }

            .headernav.open {
                padding: 2rem;
                max-height: 50rem;
            }

            .headerlist {
                flex-direction: column;
                gap: 1.5rem;
            }

            .headernav .member {
                display: none;
            }
        }
    </style>
</head>

<body>
    <div class="container">

        <!-- å›ºå®š Header -->
        <header class="header">
            <div class="headerlogo">
                <a href="/"><img src="/img/logoText.png" alt="Logo"></a>
            </div>
            <section class="mobilenav">
                <a href="#"><i class="fa-solid fa-user"></i></a>
                <div class="hamburger"><span></span><span></span><span></span></div>
            </section>
            <nav class="headernav">
                <ul class="headerlist">
                    <li class="headeritem"><a href="/match_chatroom/match.html">é…å°</a></li>
                    <li class="headeritem"><a href="/match_chatroom/chatroom.html">èŠå¤©å®¤</a></li>
                    <li class="headeritem"><a href="#">æ´»å‹•</a></li>
                    <li class="headeritem"><a href="#">è¨è«–å€</a></li>
                    <li class="headeritem"><a href="/shshop/front_end/select_page.html">MatchMarket</a></li>
                    <li class="headeritem"><a href="/login">ç™»å…¥</a></li>
                </ul>
                <a href="/signup" class="member"><i class="fa-solid fa-user"></i></a>
            </nav>
        </header>

        <div class="main-content">
            <!-- å´é‚Š -->
            <aside class="sidebar">
                <ul id="categoryList" class="category-list"></ul>
            </aside>

            <!-- èŠå¤©ä¸»å€ -->
            <main class="chat-container">
                <!-- æ¨™é¡Œ + æ–°å¢æå•æ”¾å³æ–¹ -->
                <div class="title-input">
                    <h1>Yggdrasill</h1>
                    <a th:href="@{/servicecase/sadd}" class="add-question">
                        ç„¡æ³•è§£æ±ºå—?<br>é»æ­¤æ–°å¢æå•
                    </a>
                </div>
                
                <!-- è¨Šæ¯å€ -->
                <div class="chat-messages" id="chatMessages">
                    <div class="message message-bot">
                        <p>æ‚¨å¥½ï¼è«‹å…ˆé¸æ“‡å•é¡Œé¡åˆ¥ï¼ŒAI å°‡æœƒç«‹å³å›æ‡‰ã€‚</p>
                        <span class="message-time"></span>
                    </div>
                </div>
                
                                <!-- æ‰“å­—æŒ‡ç¤º -->
                <div class="typing-indicator hidden" id="typingIndicator">
                    <div class="typing-bubble"></div>
                    <div class="typing-bubble"></div>
                    <div class="typing-bubble"></div>
                </div>

                <!-- è¼¸å…¥èˆ‡ç™¼é€ -->
                <div class="chat-input-container">
                    <input type="text" class="chat-input" id="chatInput" placeholder="è«‹è¼¸å…¥æ‚¨çš„å•é¡Œ..." disabled>
                    <button class="send-button" id="sendButton" disabled>ç™¼é€</button>
                </div>
            </main>
        </div>
    </div>

    <script defer>
        document.addEventListener('DOMContentLoaded', function () {
            let selectedCategoryId = null;
            let categories = [];

            const categoryList = document.getElementById('categoryList');
            const chatMessages = document.getElementById('chatMessages');
            const chatInput = document.getElementById('chatInput');
            const sendButton = document.getElementById('sendButton');
            const typingIndicator = document.getElementById('typingIndicator');

            // è¼‰å…¥ä¸¦æ¸²æŸ“é¡åˆ¥
            fetch('/api/casetype') // '/shakemate/api/casetype'
                .then(res => res.json())
                .then(data => {
                    categories = data;
                    categories.forEach(cat => {
                        const li = document.createElement('li');
                        li.className = 'category-item';
                        li.dataset.id = cat.caseTypeId;
                        li.textContent = cat.typeName;
                        categoryList.appendChild(li);

                        li.addEventListener('click', () => {
                            // åˆ‡æ›æ¨£å¼
                            document.querySelectorAll('.category-item').forEach(i => i.classList.remove('active'));
                            li.classList.add('active');
                            selectedCategoryId = cat.caseTypeId;

                            // å•Ÿç”¨è¼¸å…¥
                            chatInput.disabled = false;
                            sendButton.disabled = false;
                            chatInput.focus();

                            // æ¸…ç©ºèŠå¤©è¦–çª—ï¼ˆæˆ–ä¿ç•™æ­·å²ï¼‰
                            chatMessages.innerHTML = '';
                            addMessage(`æ‚¨å·²é¸æ“‡ã€Œ${cat.typeName}ã€ã€‚è«‹è¼¸å…¥å•é¡Œï¼š`, false);
                        });
                    });
                })
                .catch(err => console.error('è¼‰å…¥é¡åˆ¥å¤±æ•—', err));

            sendButton.addEventListener('click', sendMessage);
            chatInput.addEventListener('keypress', e => {
                if (e.key === 'Enter') sendMessage();
            });

            function sendMessage() {
                const msg = chatInput.value.trim();
                if (!msg || !selectedCategoryId) return;

                addMessage(msg, true);
                chatInput.value = '';
                typingIndicator.classList.remove('hidden');

                // å‘¼å« AI API
                fetch('/shakemate/api/ai/ask', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ categoryId: selectedCategoryId, question: msg })
                })
                    .then(res => res.text())
                    .then(text => {
                        typingIndicator.classList.add('hidden');
                        addMessage(text, false, true);
                    })
                    .catch(err => {
                        typingIndicator.classList.add('hidden');
                        console.error(err);
                        addMessage('æŠ±æ­‰ï¼Œå›è¦†å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦ã€‚', false);
                    });
            }

            function addMessage(content, isUser, showFeedback = false) {
                const div = document.createElement('div');
                div.className = isUser ? 'message message-user' : 'message message-bot';
                div.innerHTML = `<p>${content.replace(/\n/g, '<br>')}</p>
	  <span class="message-time">${new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })}</span>`;
                chatMessages.appendChild(div);

                if (showFeedback) {
                    const feed = document.createElement('div');
                    feed.className = 'feedback-container';
                    feed.innerHTML = `
	  <span>æœ‰å¹«åŠ©å—ï¼Ÿ</span>
	  <button class="feedback-button thumbs-up">ğŸ‘</button>
	  <button class="feedback-button thumbs-down">ğŸ‘</button>
	  `;
                    div.appendChild(feed);

                    // æ‰¾åˆ°æ™‚é–“å…ƒç´ 
                    const timeEl = div.querySelector('.message-time');

                    // é»æ“Šå¾Œå°‡ feedback container ç§»é™¤ï¼Œä¸¦åœ¨ timeEl ä¹‹å‰æ’å…¥æ„Ÿè¬æ–‡å­—
                    const thankSpan = document.createElement('span');
                    thankSpan.className = 'feedback-thanks';
                    thankSpan.textContent = 'æ„Ÿè¬æ‚¨çš„å›è¦†ï¼';
                    thankSpan.style.color = 'gray';
                    thankSpan.style.marginRight = '8px'; // èˆ‡æ™‚é–“éš”é–‹ä¸€é»

                    // ç¶å®šæŒ‰éˆ•äº‹ä»¶
                    feed.querySelector('.thumbs-up').addEventListener('click', () => {
                        alert('æ„Ÿè¬æ‚¨çš„æ­£é¢å›é¥‹ï¼'); // ä½ å¯ä»¥æ”¹ç‚ºé€å‡º API ç­‰ç­‰
                    });
                    feed.querySelector('.thumbs-down').addEventListener('click', () => {
                        alert('æˆ‘å€‘æœƒæŒçºŒæ”¹é€²ï¼Œæ„Ÿè¬æ‚¨ï¼');
                    });


                    // é»æ“Šäº‹ä»¶è™•ç†å‡½å¼
                    const handleFeedback = () => {
                        feed.remove(); // ç§»é™¤åº•ä¸‹é‚£æ•´å¨æŒ‰éˆ•
                        timeEl.parentNode.insertBefore(thankSpan, timeEl);
                    };

                    feed.querySelector('.thumbs-up').addEventListener('click', handleFeedback);
                    feed.querySelector('.thumbs-down').addEventListener('click', handleFeedback);
                }
                chatMessages.scrollTop = chatMessages.scrollHeight;
            }
        });
    </script>

</body>

</html>