<!DOCTYPE html>
<html lang="zh-Hant">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>商品上架｜二手商城</title>
  <link rel="stylesheet" href="../css/header.css" />
  <link rel="stylesheet" href="../css/add_product.css" />
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet" />

</head>

<body>

  <header class="header">
    <div class="header__logo">
      <a href="#"><img src="../img/logoText.png" alt="Logo" /></a>
    </div>
    <nav class="header__nav">
      <ul class="header__list">
        <li class="header__item"><a href="#">配對</a></li>
        <li class="header__item"><a href="#">聊天室</a></li>
        <li class="header__item"><a href="#">活動</a></li>
        <li class="header__item"><a href="#">討論區</a></li>
        <li class="header__item"><a href="#">商城</a></li>
        <li class="header__item"><a href="#">二手商城</a></li>
        <li class="header__item"><a href="#">會員專區</a></li>
      </ul>
    </nav>
    <i class="fa-solid fa-user"></i>
  </header>

  <div class="feature-bar">
    <a href="#" class="feature-link">瀏覽二手商品</a>
    <a href="#" class="feature-link">我的二手商品</a>
    <a href="#" class="feature-link">上架二手商品</a>
    <a href="#" class="feature-link">已購賣商品</a>
  </div>
<main class="form-wrapper">
  <h1>上架二手商品</h1>

  <form class="form-layout" method="post" action="http://localhost:8087/api/ShShop/addNewProd"
    enctype="multipart/form-data">

    <!-- ✅ 基本資料 -->
    <section class="form-section">
      <div class="form-label-col">
        <p>基本資訊</p>
      </div>
      <div class="form-input-col">
        <div class="form-group">
          <label>Product Name:</label>
          <input type="text" name="prodName">
          <div class="error-msg" id="prodNameError"></div>
        </div>

        <div class="form-group">
          <label>Product Brand:</label>
          <input type="text" name="prodBrand">
          <div class="error-msg" id="prodBrandError"></div>
        </div>

        <div class="form-group">
          <label>Product category:</label>
          <select name="prodTypeId">
            <option value="">Product Type</option>
          </select>
          <div class="error-msg" id="prodTypeIdError"></div>
        </div>

        <div class="form-row -number">
          <div class="form-group">
            <label>Product Price:</label>
            <input type="number" name="prodPrice">
            <div class="error-msg" id="prodPriceError"></div>
          </div>

          <div class="form-group">
            <label>Product Qty:</label>
            <input type="number" name="prodCount" value="1">
            <div class="error-msg" id="prodCountError"></div>
          </div>
        </div>

        <div class="form-group">
          <label>Product content:</label>
          <textarea name="prodContent" rows="4"></textarea>
          <div class="error-msg" id="prodContentError"></div>
        </div>
      </div>
    </section>

    <!-- ✅ 圖片 -->
    <section class="form-section">
      <div class="form-label-col">
        <p>圖片</p>
      </div>
      <div class="form-input-col">
        <div class="image-preview-row">
          <div class="img-box">img</div>
          <div class="img-box">img</div>
          <div class="img-box">img</div>
          <div class="img-box">img</div>
          <div class="img-box">img</div>
        </div>
        <div class="form-group">
          <label>圖片（可多選）：</label>
          <input type="file" name="prodImage" accept="image/*" multiple>
        </div>
      </div>
    </section>

    <!-- ✅ 介紹 -->
    <section class="form-section">
      <div class="form-label-col">
        <p>介紹</p>
      </div>
      <div class="form-input-col">
        <label>Product info:</label>
        <textarea name="prodStatusDesc" rows="5"></textarea>
        <div class="error-msg" id="prodStatusDescError"></div>
      </div>
    </section>

    <!-- ✅ 按鈕區 -->
    <div class="button-row">
      <input type="hidden" name="action" value="createProd" />
      <button type="reset" class="discard">discard</button>
      <button type="submit" class="save">save</button>
    </div>
  </form>
</main>

  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>
  <script> // 這裡是載入類別
    $(document).ready(function () {
      $.ajax({
        url: "http://localhost:8087/api/ShShop/allTypes",
        method: "GET",
        data: {
          action: "allTypes"
        },
        dataType: "json",
        success: function (data) {
          const $select = $('select[name="prodTypeId"]');
          $select.empty().append('<option value="">Product Type</option>');
          data.forEach(function (type) {
            $select.append(
              `<option value="${type.prodTypeId}">${type.prodTypeName}</option>`
            );
          });
        },
        error: function (xhr, status, error) {
          console.error("載入分類失敗", error);
        }
      });
    });
  </script>

  <script>
    document.addEventListener("DOMContentLoaded", function () {
      const form = document.querySelector(".form-layout");

      form.addEventListener("submit", function (e) {
        e.preventDefault(); // 阻止原始提交

        // 清除舊的錯誤提示
        document.querySelectorAll(".error-msg").forEach(el => el.innerText = "");

        const formData = new FormData(form);

        fetch("http://localhost:8087/api/ShShop/addNewProd", {
          method: "POST",
          body: formData
        })
          .then(response => {
            if (!response.ok) throw new Error("伺服器錯誤");
            return response.json();
          })
          .then(data => {
            if (data.status === "success") {
              const prodId = data.data.prodId;
              if (prodId) {
                window.location.href = `http://localhost:8087/api/ShShop/product_page.html?id=${prodId}`;
              } else {
                alert("商品上傳成功，但找不到商品編號！");
              }
            } else if (data.status === "error") {
              // ✅ 顯示錯誤訊息
              for (const field in data.errors) {
                const errBox = document.querySelector(`#${field}Error`);
                if (errBox) errBox.innerText = data.errors[field];
              }
            }
          })
          .catch(error => {
            alert("商品上傳失敗！");
            console.error(error);
          });
      });
    });
  </script>



  <script>
    // $(document).ready(function () {

    //   // ✅ 商品上架表單提交事件
    //   $(".form-layout").on("submit", function (e) {
    //     e.preventDefault(); // 阻止表單預設提交行為

    //     const formData = {
    //       action: "add",
    //       userId: 1, // 之後改成動態帶入的會員ID
    //       prodName: $("input[name='prodName']").val(),
    //       prodBrand: $("input[name='prodBrand']").val(),
    //       prodTypeId: $("select[name='prodTypeId']").val(),
    //       prodPrice: $("input[name='prodPrice']").val(),
    //       prodCount: $("input[name='prodCount']").val(),
    //       prodContent: $("textarea[name='prodContent']").val(),
    //       prodStatusDesc: $("textarea[name='prodStatusDesc']").val(),
    //       prodStatus: 1, // 預設為上架狀態（1 = 有效）
    //       shProdPicUrl: ["https://placehold.co/400x300"] // 你之後要改成圖片上傳功能
    //     };

    //     $.ajax({
    //       url: "http://localhost:8081/CJA10138_Webapp_war_exploded/newOne",
    //       method: "POST",
    //       contentType: "application/json",
    //       data: JSON.stringify(formData),
    //       success: function (res) {
    //         alert("上架成功！");
    //         console.log(res);
    //       },
    //       error: function (xhr, status, error) {
    //         alert("上架失敗！");
    //         console.error(error);
    //       }
    //     });
    //   });
    // });
  </script>

</body>

</html>