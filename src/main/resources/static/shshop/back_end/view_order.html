<!DOCTYPE html>
<html lang="zh-Hant">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>MatchMarket - è¨‚å–®è©³æƒ…</title>
  <link rel="stylesheet" href="./css/view_order.css">
</head>

<body>

  <!-- å´é‚Šæ¬„ -->
  <aside>
    <h2>ç®¡ç†å¾Œå°</h2>
    <nav>
      <ul>
        <li><a href="#">ğŸ“¦ å•†å“ç®¡ç†</a></li>
        <li><a href="#" class="active">ğŸ§¾ è¨‚å–®ç®¡ç†</a></li>
        <li><a href="#">ğŸ‘¤ ä½¿ç”¨è€…ç®¡ç†</a></li>
        <li><a href="#">ğŸ“Š å„€è¡¨æ¿</a></li>
        <li><a href="#">ğŸšª ç™»å‡º</a></li>
      </ul>
    </nav>
  </aside>

  <!-- ä¸»å…§å®¹ -->
  <main>
    <header>
      <h1>è¨‚å–®è©³æƒ…</h1>
    </header>

    <!-- ä¸ŠåŠéƒ¨ -->
    <div class="order-detail-container">

      <!-- å·¦ï¼šå•†å“è³‡è¨Š -->
      <div class="left-column">
        <h3>ğŸ“¦ å•†å“è³‡è¨Š</h3>
        <div class="product-info" id="productInfo">
          <!-- å•†å“è³‡æ–™ç”±JSå¡«å…¥ -->
        </div>
      </div>

      <!-- å³ï¼šè¨‚å–®è³‡è¨Š -->
      <div class="right-column" id="orderContent">
        <!-- è¨‚å–®è³‡è¨Šç”±JSå¡«å…¥ -->
      </div>
    </div>

    <!-- ä¸‹åŠéƒ¨ï¼šç‹€æ…‹ç®¡ç† -->
    <div class="status-management">
      <h3>ğŸ› ï¸ è¨‚å–®ç‹€æ…‹ç®¡ç†</h3>

      <div class="form-group">
        <label>è¨‚å–®ç‹€æ…‹ï¼š</label>
        <select id="orderStatus">
          <option value="0">è™•ç†ä¸­</option>
          <option value="1">å·²å®Œæˆ</option>
          <option value="2">å·²å–æ¶ˆ</option>
          <option value="3">ç³¾ç´›è™•ç†ä¸­</option>
        </select>
      </div>

      <div class="form-group">
        <label>ä»˜æ¬¾ç‹€æ…‹ï¼š</label>
        <select id="paymentStatus">
          <option value="0">æœªä»˜æ¬¾</option>
          <option value="1">å·²ä»˜æ¬¾</option>
          <option value="2">å·²é€€æ¬¾</option>
        </select>
      </div>

      <div class="form-group">
        <label>é‹é€ç‹€æ…‹ï¼š</label>
        <select id="shippingStatus">
          <option value="0">å‚™è²¨ä¸­</option>
          <option value="1">å·²å‡ºè²¨</option>
          <option value="2">å·²é€é”</option>
        </select>
      </div>

      <div class="form-group">
        <label>é‹é€å–®è™Ÿï¼š</label>
        <input type="text" id="shippingNote" placeholder="è«‹è¼¸å…¥é‹é€å–®è™Ÿ">
      </div>

      <div class="form-group">
        <label>è¨‚å–®å‚™è¨»ï¼ˆç®¡ç†å“¡ï¼‰</label>
        <textarea id="orderNote" rows="3" placeholder="è¼¸å…¥å‚™è¨»..."></textarea>
      </div>

      <div class="btn-group">
        <button onclick="saveChanges()">ğŸ’¾ å„²å­˜è®Šæ›´</button>
        <button onclick="cancelOrder()">âŒ å–æ¶ˆè¨‚å–®</button>
        <button onclick="markDispute()">âš–ï¸ è™•ç†ç³¾ç´›</button>
        <button onclick="window.history.back()">è¿”å›</button>
      </div>
    </div>

  </main>

    </main>

    <!-- =============== JS =============== -->
    <script>
        let currentOrder = null;
        const orderId = localStorage.getItem('viewOrderId');

        document.addEventListener("DOMContentLoaded", () => {
            if (!orderId) {
                alert("æœªæ‰¾åˆ°è¨‚å–®IDï¼Œè«‹å¾è¨‚å–®åˆ—è¡¨é€²å…¥ã€‚");
                window.location.href = "order_manager.html";
                return;
            }

            fetch(`http://localhost:8080/api/shorder/${orderId}`)
                .then(res => res.json())
                .then(json => {
                    if (json.status === 200 && json.data) {
                        currentOrder = json.data;
                        renderOrderDetail(json.data);
                    } else {
                        document.getElementById('orderContent').innerHTML = `<p>æŸ¥ç„¡æ­¤è¨‚å–®</p>`;
                        document.getElementById('productInfo').innerHTML = "";
                    }
                });
        });

        function renderOrderDetail(order) {
            // ç‹€æ…‹é¸å–®åˆå§‹åŒ–
            document.getElementById('orderStatus').value = order.orderStatus;
            document.getElementById('paymentStatus').value = order.paymentStatus;
            document.getElementById('shippingStatus').value = order.shippingStatus;
            document.getElementById('orderNote').value = order.orderNote || "";
            document.getElementById('shippingNote').value = order.shippingAddress || "";

            // å·¦å´è¨‚å–®è³‡æ–™
            const html = `
    <h2>è¨‚å–®ç·¨è™Ÿï¼š#${order.shOrderId}</h2>

    <div class="section">
      <h3>ğŸ‘¤ è²·å®¶è³‡è¨Š</h3>
      <p><strong>åç¨±ï¼š</strong>${order.buyerName}</p>
      <p><strong>Emailï¼š</strong>${order.buyerEmail}</p>
    </div>

    <div class="section">
      <h3>ğŸ‘¤ è³£å®¶è³‡è¨Š</h3>
      <p><strong>åç¨±ï¼š</strong>${order.sellerName}</p>
      <p><strong>Emailï¼š</strong>${order.sellerEmail}</p>
    </div>

    <div class="section">
      <h3>ğŸ“œ è¨‚å–®è³‡è¨Š</h3>
      <p><strong>ä¸‹å–®æ™‚é–“ï¼š</strong> ${formatDateTime(order.orderDate)}</p>
      <p><strong>ä»˜æ¬¾æ–¹å¼ï¼š</strong> ${order.paymentMethodStr}</p>
      <p><strong>ä»˜æ¬¾ç‹€æ…‹ï¼š</strong> ${order.paymentStatusStr}</p>
      <p><strong>é‹é€æ–¹å¼ï¼š</strong> ${order.shippingMethodStr}</p>
      <p><strong>é‹é€ç‹€æ…‹ï¼š</strong> ${order.shippingStatusStr}</p>
      <p><strong>è¨‚å–®ç‹€æ…‹ï¼š</strong> ${order.orderStatusStr}</p>
      <p><strong>é‹è²»ï¼š</strong> NT$ ${order.shippingFee}</p>
      <p><strong>å¹³å°æ‰‹çºŒè²»ï¼š</strong> NT$ ${order.platformFee}</p>
      <p><strong>é‹é€åœ°å€ï¼š</strong> ${order.shippingAddress}</p>
    </div>
  `;
            document.getElementById('orderContent').innerHTML = html;

            // å³å´å•†å“è³‡è¨Š
            const productHtml = `
    <img src="${order.shProd.picUrls?.[0] || 'https://placehold.co/300x300?text=No+Image'}" alt="å•†å“åœ–ç‰‡">
    <p><strong>åç¨±ï¼š</strong>${order.shProd.prodName}</p>
    <p><strong>å“ç‰Œï¼š</strong>${order.shProd.prodBrand}</p>
    <p><strong>æè¿°ï¼š</strong>${order.shProd.prodDesc}</p>
    <p><strong>å–®åƒ¹ï¼š</strong>NT$ ${order.productPrice}</p>
    <p><strong>æ•¸é‡ï¼š</strong>${order.productQuantity}</p>
    <p><strong>ç¸½é‡‘é¡ï¼š</strong>NT$ ${order.totalAmount}</p>
  `;
            document.getElementById('productInfo').innerHTML = productHtml;
        }

        // âœ… å„²å­˜è®Šæ›´
        function saveChanges() {
            const payload = {
                orderId: currentOrder.shOrderId,
                orderStatus: parseInt(document.getElementById('orderStatus').value),
                paymentStatus: parseInt(document.getElementById('paymentStatus').value),
                shippingStatus: parseInt(document.getElementById('shippingStatus').value),
                orderNote: document.getElementById('orderNote').value.trim(),
                shippingAddress: document.getElementById('shippingNote').value.trim()
            };

            fetch(`http://localhost:8080/api/shorder/updateStatus`, {
                method: "POST",
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            })
                .then(res => res.json())
                .then(json => {
                    alert("æ›´æ–°æˆåŠŸï¼");
                    location.reload();
                })
                .catch(err => {
                    console.error("æ›´æ–°å¤±æ•—", err);
                    alert("æ›´æ–°å¤±æ•—");
                });
        }

        // âœ… å–æ¶ˆè¨‚å–®
        function cancelOrder() {
            if (!confirm("ç¢ºå®šè¦å–æ¶ˆæ­¤è¨‚å–®ï¼Ÿ")) return;
            document.getElementById('orderStatus').value = 2; // å·²å–æ¶ˆ
            saveChanges();
        }

        // âœ… æ¨™è¨˜ç‚ºç³¾ç´›
        function markDispute() {
            if (!confirm("ç¢ºå®šå°‡æ­¤è¨‚å–®æ¨™è¨˜ç‚ºç³¾ç´›è™•ç†ä¸­ï¼Ÿ")) return;
            document.getElementById('orderStatus').value = 3; // ç³¾ç´›è™•ç†ä¸­
            saveChanges();
        }

        // âœ… å·¥å…·ï¼šæ™‚é–“æ ¼å¼åŒ–
        function formatDateTime(dateStr) {
            const date = new Date(dateStr);
            return `${date.getFullYear()}-${pad(date.getMonth() + 1)}-${pad(date.getDate())} ${pad(date.getHours())}:${pad(date.getMinutes())}:${pad(date.getSeconds())}`;
        }

        function pad(n) {
            return n.toString().padStart(2, '0');
        }

    </script>
</body>

</html>