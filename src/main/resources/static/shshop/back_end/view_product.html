<!DOCTYPE html>
<html lang="zh-Hant">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>商品詳細內容管理｜MatchMarket 後台</title>
    <link rel="stylesheet" href="css/view_product.css" />
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet" />
</head>

<body>
    <aside>
        <h2>MatchMarket 後台</h2>
        <nav>
            <ul>
                <li><a href="product_manager.html">商品管理</a></li>
                <li><a href="#">會員管理</a></li>
                <li><a href="#">訂單管理</a></li>
                <li><a href="#">系統設定</a></li>
            </ul>
        </nav>
    </aside>

    <main>
        <header>
            <h1>商品詳細內容</h1>
        </header>

        <div class="content-section">
            <div class="product-page">
                <div class="left-image-box">
                    <div class="main-img">
                        <img src="https://placehold.co/300x300" alt="主圖">
                    </div>
                    <div class="thumbnail-bar">
                        <button class="nav-arrow">←</button>
                        <img src="https://placehold.co/80x80" alt="圖1">
                        <img src="https://placehold.co/80x80" alt="圖2">
                        <img src="https://placehold.co/80x80" alt="圖3">
                        <button class="nav-arrow">→</button>
                    </div>
                </div>

                <div class="right-info-box">
                    <h1>商品名稱：<span id="prodName"></span></h1>
                    <div class="info-grid">
                        <p class="brand"><strong>商品品牌：</strong><span id="prodBrand"></span></p>
                        <p><strong class="qty">商品數量：</strong><span id="prodCount"></span></p>
                        <p><strong class="price">商品價格：</strong>$<span id="prodPrice"></span></p>
                        <p><strong class="prod_type">商品性質：</strong><span id="prodType"></span></p>
                        <p><strong class="prod_view">商品瀏覽次數：</strong><span id="prodViews"></span></p>
                        <p><strong class="prod_status">商品狀態：</strong><span id="prodStatus" class="status-tag"></span></p>
                    </div>
                    <div class="action-buttons">
                        <button class="btn-action btn-edit" id="toggleStatusBtn">狀態切換</button>
                        <button class="btn-action btn-toggle" id="rejectBtn">審核不通過</button>
                    </div>
                </div>
            </div>

            <section class="product-section">
                <h2>商品內容：</h2>
                <p id="prodContent">商品內容介紹...</p>
            </section>

            <section class="product-section">
                <h2>商品敘述：</h2>
                <p id="prodDesc">商品的詳細描述或說明</p>
            </section>

            <section class="product-section">
                <h2>賣家會員資料：</h2>
                <p id="sellerInfo">賣家暱稱、評價、介紹等資訊</p>
            </section>
        </div>
    </main>

    <script>
        document.addEventListener("DOMContentLoaded", function () {
            const productId = localStorage.getItem('viewProdId');
            if (!productId) {
                console.error("查無商品 ID");
                // 可以導向回商品管理頁面或顯示錯誤訊息
                return;
            }

            // 載入商品資料
            function loadProductData() {
                fetch("http://localhost:8087/api/ShShop/reviewProd", {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/x-www-form-urlencoded"
                    },
                    body: new URLSearchParams({ id: productId })
                })
                .then(response => {
                    if (!response.ok) {
                        throw new Error("後端回傳錯誤");
                    }
                    return response.json();
                })
                .then(responseData => {
                    const data = responseData.data;

                    // 主圖
                    const mainImg = document.querySelector(".main-img img");
                    if (data.picUrls && data.picUrls.length > 0) {
                        mainImg.src = data.picUrls[0];
                        mainImg.alt = data.prodName;
                    }

                    // 商品名稱
                    document.getElementById("prodName").textContent = data.prodName;

                    // 品牌
                    document.getElementById("prodBrand").textContent = data.prodBrand;
                    // 數量
                    document.getElementById("prodCount").textContent = data.prodCount;
                    // 價錢
                    document.getElementById("prodPrice").textContent = data.prodPrice;
                    // 商品性質（類別）
                    document.getElementById("prodType").textContent = data.prodTypeName;
                    // 瀏覽次數
                    document.getElementById("prodViews").textContent = data.prodViews;
                    // 商品狀態
                    const prodStatusElement = document.getElementById("prodStatus");
                    prodStatusElement.textContent = data.prodStatusStr;
                    prodStatusElement.className = 'status-tag'; // Reset classes
                    if (data.prodStatus === 1) {
                        prodStatusElement.classList.add('status-up');
                    } else if (data.prodStatus === 0) {
                        prodStatusElement.classList.add('status-down');
                    } else {
                        prodStatusElement.classList.add('status-pending');
                    }


                    // 商品內容
                    document.getElementById("prodContent").textContent = data.prodContent;
                    // 商品敘述
                    document.getElementById("prodDesc").textContent = data.prodDesc;
                    // 賣家資訊
                    document.getElementById("sellerInfo").textContent = `上架者：${data.userName}`;

                    // 商品縮圖
                    const thumbnails = document.querySelectorAll(".thumbnail-bar img");
                    data.picUrls.forEach((url, index) => {
                        if (thumbnails[index]) {
                            thumbnails[index].src = url;
                            thumbnails[index].alt = `商品圖${index + 1}`;
                        }
                    });

                    // 根據商品狀態設定按鈕文字
                    const toggleStatusBtn = document.getElementById("toggleStatusBtn");
                    if (data.prodStatus === 1) {
                        toggleStatusBtn.textContent = '下架商品';
                        toggleStatusBtn.dataset.action = 'delist';
                    } else {
                        toggleStatusBtn.textContent = '上架商品';
                        toggleStatusBtn.dataset.action = 'list';
                    }
                })
                .catch(err => {
                    console.error("載入商品資料失敗：", err);
                });
            }

            loadProductData(); // 初次載入商品資料

            // 上架/下架按鈕功能
            document.getElementById("toggleStatusBtn").addEventListener("click", function() {
                const action = this.dataset.action;
                const newStatus = action === 'list' ? 1 : 0; // 1 for list, 0 for delist

                fetch("http://localhost:8087/api/ShShop/updateProdStatus", { // 假設有一個更新狀態的 API
                    method: "POST",
                    headers: {
                        "Content-Type": "application/x-www-form-urlencoded"
                    },
                    body: new URLSearchParams({ id: productId, status: newStatus })
                })
                .then(response => {
                    if (!response.ok) {
                        throw new Error("更新商品狀態失敗");
                    }
                    return response.json();
                })
                .then(data => {
                    if (data.success) {
                        alert(`商品已${action === 'list' ? '上架' : '下架'}！`);
                        loadProductData(); // 重新載入資料以更新狀態顯示
                    } else {
                        alert(`操作失敗: ${data.message}`);
                    }
                })
                .catch(error => {
                    console.error("Error toggling product status:", error);
                    alert("更新商品狀態時發生錯誤。");
                });
            });

            // 審核不通過按鈕功能
            document.getElementById("rejectBtn").addEventListener("click", function() {
                const reason = prompt("請輸入審核不通過的原因：");
                if (reason) {
                    fetch("http://localhost:8087/api/ShShop/rejectProd", { // 假設有一個審核不通過的 API
                        method: "POST",
                        headers: {
                            "Content-Type": "application/x-www-form-urlencoded"
                        },
                        body: new URLSearchParams({ id: productId, reason: reason })
                    })
                    .then(response => {
                        if (!response.ok) {
                            throw new Error("審核不通過操作失敗");
                        }
                        return response.json();
                    })
                    .then(data => {
                        if (data.success) {
                            alert("商品已設定為審核不通過！");
                            loadProductData(); // 重新載入資料以更新狀態顯示
                        } else {
                            alert(`操作失敗: ${data.message}`);
                        }
                    })
                    .catch(error => {
                        console.error("Error rejecting product:", error);
                        alert("審核不通過操作時發生錯誤。");
                    });
                } else if (reason !== null) {
                    alert("請輸入不通過原因。");
                }
            });
        });
    </script>

</body>

</html>