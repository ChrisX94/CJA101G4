<!DOCTYPE html>
<html lang="zh-Hant">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>æ›´æ–°å•†å“ï½œMatchMarket</title>
  <link rel="stylesheet" href="css/header.css" />
  <link rel="stylesheet" href="css/edit_product.css" />
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet" />

</head>

<body>

  <header class="header">
    <!-- Logo å€ -->
    <div class="header__logo">
      <a href="/">
        <img src="../../img/logoText.png" alt="Logo" />
      </a>
    </div>

    <!-- å°è¦½åˆ— -->
    <nav class="header__nav">
      <ul class="header__list">
        <li class="header__item"><a href="#">é…å°</a></li>
        <li class="header__item"><a href="#">èŠå¤©å®¤</a></li>
        <li class="header__item"><a href="#">æ´»å‹•</a></li>
        <li class="header__item"><a href="#">è¨è«–å€</a></li>

        <!-- ğŸ”½ MatchMarket Dropdown -->
        <li class="header__item dropdown">
          <a href="select_page.html">MatchMarket</a>
          <ul class="dropdown-menu">
            <li><a href="select_page.html">çœ‹ä¸€ä¸‹å•†å“</a></li>
            <li class="dropdown-submenu">
              <a href="product_manager.html">My MatchMarket</a>
              <ul class="dropdown-menu">
                <li><a href="add_product.html">ä¸Šæ¶å•†å“</a></li>
                <li><a href="#">å·²è³¼è³£å•†å“</a></li>
              </ul>
            </li>
          </ul>
        </li>

        <li class="header__item"><a href="#">æœƒå“¡å°ˆå€</a></li>
      </ul>
    </nav>

    <!-- ä½¿ç”¨è€…åœ–ç¤º -->
    <div class="header__user">
      <i class="fa-solid fa-user"></i>
    </div>
  </header>

  <main class="form-wrapper">
    <div class="form-header-row">
      <h1>æ›´æ–°å•†å“</h1>
      <div class="form-group status-group">
        <label>å•†å“ç‹€æ…‹ï¼š</label>
        <span id="prodStatusDisplay" class="status-text">è¼‰å…¥ä¸­...</span>
      </div>
    </div>

    <form class="form-layout" method="post" action="http://localhost:8087/api/ShShop/updateProd"
      enctype="multipart/form-data">
      <input type="hidden" id="prodId" name="prodId" value="">

      <!-- âœ… åŸºæœ¬è³‡æ–™ -->
      <section class="form-section">
        <div class="form-label-col">
          <p>åŸºæœ¬è³‡è¨Š</p>
        </div>
        <div class="form-input-col">

          <div class="form-group">
            <label>å•†å“åç¨±ï¼š</label>
            <input type="text" name="prodName" placeholder="è«‹è¼¸å…¥å•†å“åç¨±">
            <div class="error-msg" id="prodNameError"></div>
          </div>

          <div class="form-group">
            <label>å“ç‰Œï¼š</label>
            <input type="text" name="prodBrand" placeholder="è«‹è¼¸å…¥å“ç‰Œåç¨±">
            <div class="error-msg" id="prodBrandError"></div>
          </div>

          <div class="form-group">
            <label>å•†å“åˆ†é¡ï¼š</label>
            <select name="prodTypeId">
              <option value="">è«‹é¸æ“‡åˆ†é¡</option>
            </select>
            <div class="error-msg" id="prodTypeIdError"></div>
          </div>

          <div class="form-row -number">
            <div class="form-group">
              <label>åƒ¹æ ¼ï¼š</label>
              <input type="number" name="prodPrice" placeholder="å–®ä½ï¼šå…ƒ">
              <div class="error-msg" id="prodPriceError"></div>
            </div>

            <div class="form-group">
              <label>æ•¸é‡ï¼š</label>
              <input type="number" name="prodCount" value="1" placeholder="é è¨­ç‚º 1">
              <div class="error-msg" id="prodCountError"></div>
            </div>
          </div>

          <div class="form-group">
            <label>ç°¡è¦æè¿°ï¼š</label>
            <textarea name="prodContent" rows="4" placeholder="è«‹è¼¸å…¥å•†å“ç°¡ä»‹..."></textarea>
            <div class="error-msg" id="prodContentError"></div>
          </div>
        </div>
      </section>

      <!-- âœ… åœ–ç‰‡ -->
      <section class="form-section">
        <div class="form-label-col">
          <p>åœ–ç‰‡</p>
        </div>
        <div class="form-input-col">
          <div class="form-group">
            <label>å•†å“åœ–ç‰‡ï¼ˆæœ€å¤š 5 å¼µï¼Œå»ºè­°å°ºå¯¸ï¼š800x800ï¼‰ï¼š</label>
            <div class="image-preview-row" id="existingPreviewContainer">
              <!-- åŸåœ–é è¦½å®¹å™¨ -->
            </div>
            <input type="file" id="prodImageInput" name="prodImage" accept="image/*" multiple>
          </div>
        </div>
      </section>

      <!-- âœ… å•†å“èªªæ˜ -->
      <section class="form-section">
        <div class="form-label-col">
          <p>å•†å“èªªæ˜</p>
        </div>
        <div class="form-input-col">
          <label>å•†å“ç‹€æ³èªªæ˜ï¼š</label>
          <textarea name="prodStatusDesc" rows="5" placeholder="ä¾‹å¦‚ï¼šäºŒæ‰‹è‰¯å“ã€ä¹æˆæ–°ã€æœªæ‹†å°ç­‰..."></textarea>
          <div class="error-msg" id="prodStatusDescError"></div>
        </div>
      </section>

      <!-- âœ… æŒ‰éˆ• -->
      <div class="button-row">
        <input type="hidden" name="action" value="updateProd" />
        <button type="reset" class="discard">é‡è¨­</button>
        <button type="submit" class="save">å„²å­˜è®Šæ›´</button>
      </div>
    </form>
  </main>

  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>
  <script src="js/shshopType.js">  </script>

  <script>
    document.addEventListener("DOMContentLoaded", function () {
      const prodId = localStorage.getItem("editingProdId");
      const prodStatus = localStorage.getItem("prodStatus");
      const form = document.querySelector(".form-layout");
      const statusSpan = document.getElementById("prodStatusDisplay");
      const prodIdInput = document.getElementById("prodId");
      const originalImagesContainer = document.getElementById("existingPreviewContainer");
      const removedPicUrls = [];

      if (statusSpan) statusSpan.innerText = prodStatus || "æœªæä¾›";
      if (prodId && prodIdInput) prodIdInput.value = prodId;

      // åˆå§‹åŒ–å–å¾—å•†å“è³‡æ–™
      const initFormData = new FormData();
      initFormData.append("id", prodId);

      fetch("http://localhost:8087/api/ShShop/getProd", {
        method: "POST",
        body: initFormData
      })
        .then(res => res.json())
        .then(data => {
          const prod = data.data;
          if (!prod) throw new Error("æ‰¾ä¸åˆ°å•†å“è³‡æ–™");

          // å¡«å…¥è¡¨å–®æ¬„ä½
          form.prodName.value = prod.prodName;
          form.prodBrand.value = prod.prodBrand;
          form.prodPrice.value = prod.prodPrice;
          form.prodCount.value = prod.prodCount;
          form.prodContent.value = prod.prodContent;
          form.prodStatusDesc.value = prod.prodDesc;

          // é¡åˆ¥ä¸‹æ‹‰è¼‰å…¥å®Œå†è¨­å®šé¸é …
          const select = form.prodTypeId;
          const timer = setInterval(() => {
            if (select.options.length > 1) {
              select.value = prod.prodTypeId?.toString();
              clearInterval(timer);
            }
          }, 100);

          // ç”¢ç”ŸåŸå§‹åœ–ç‰‡å€å¡Š
          console.log(prod.picUrls);
          if (!prod.picUrls || prod.picUrls.length === 0) {
            originalImagesContainer.innerHTML = "<p>å°šæœªä¸Šå‚³åœ–ç‰‡</p>";
            return;
          }
          originalImagesContainer.innerHTML = "";
          prod.picUrls?.forEach((url, idx) => {
            const imgBox = document.createElement("div");
            imgBox.classList.add("img-box");
            imgBox.innerHTML = `
          <div class="img-wrapper">
            <img src="${url}" alt="åœ–ç‰‡${idx + 1}" />
            <button type="button" class="delete-btn" data-url="${url}">&times;</button>
          </div>
        `;
            originalImagesContainer.appendChild(imgBox);
          });

          form.action.value = "updateProd";
        })
        .catch(err => {
          alert("ç„¡æ³•è¼‰å…¥å•†å“è³‡æ–™ï¼Œè«‹ç¨å¾Œå†è©¦");
          console.error(err);
        });

      // ğŸ—‘ï¸ é»æ“Šåˆªé™¤åœ–ç¤º
      originalImagesContainer.addEventListener("click", function (e) {
        if (e.target.classList.contains("delete-btn")) {
          const imgBox = e.target.closest(".img-box");
          const url = e.target.getAttribute("data-url");

          if (url && !removedPicUrls.includes(url)) {
            removedPicUrls.push(url); // è¨˜éŒ„è¦åˆªçš„åœ–
          }

          if (imgBox) imgBox.remove(); // å‰ç«¯ç§»é™¤
        }
      });

      // âœ… å³æ™‚é è¦½æ–°ä¸Šå‚³åœ–ç‰‡
      const fileInput = form.querySelector('input[name="prodImage"]');
      const previewBoxes = document.querySelectorAll(".img-box");

      fileInput.addEventListener("change", function () {
        const files = Array.from(fileInput.files);

        previewBoxes.forEach((box, idx) => {
          if (files[idx]) {
            const reader = new FileReader();
            reader.onload = e => {
              box.innerHTML = `
            <img src="${e.target.result}" style="width:100%; height:100%; object-fit: cover;" />
          `;
            };
            reader.readAsDataURL(files[idx]);
          } else {
            box.innerHTML = "img";
          }
        });
      });

      // âœ… è¡¨å–®é€å‡ºè™•ç†ï¼ˆæ›´æ–°å•†å“ï¼‰
      form.addEventListener("submit", function (e) {
        e.preventDefault();

        // æ¸…é™¤éŒ¯èª¤è¨Šæ¯
        form.querySelectorAll(".error-msg").forEach(el => (el.innerText = ""));

        const submitData = new FormData(form);

        // åŠ å…¥è¢«åˆªé™¤çš„åœ–ç‰‡ URL
        removedPicUrls.forEach((url, idx) => {
          submitData.append(`removePicUrls[${idx}]`, url);
        });

        fetch("http://localhost:8087/api/ShShop/updateProd", {
          method: "POST",
          body: submitData
        })
          .then(response =>
            response.json().then(data => ({ status: response.status, body: data }))
          )
          .then(({ status, body }) => {
            if (body.message === "success") {
              const updatedId = body.data?.prodId;
              if (updatedId) {
                window.location.href = `product_page.html?id=${updatedId}`;
              } else {
                alert("æ›´æ–°æˆåŠŸï¼Œä½†æ‰¾ä¸åˆ°å•†å“ç·¨è™Ÿï¼");
              }
            } else if (status === 400 && body.message === "validation_failed") {
              const errors = body.errors || {};
              for (const field in errors) {
                const errBox = document.getElementById(`${field}Error`);
                if (errBox) errBox.innerText = errors[field];
              }
            } else {
              alert("ç™¼ç”ŸéŒ¯èª¤ï¼š" + (body.message || "è«‹ç¨å¾Œå†è©¦"));
            }
          })
          .catch(error => {
            alert("å•†å“æ›´æ–°å¤±æ•—ï¼");
            console.error(error);
          });
      });
    });

    // âœ… é›¢é–‹æ¸…é™¤æš«å­˜è³‡æ–™
    window.addEventListener("beforeunload", () => {
      localStorage.removeItem("editingProdId");
      localStorage.removeItem("prodStatus");
    });

  </script>




</body>

</html>