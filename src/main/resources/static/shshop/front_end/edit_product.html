<!DOCTYPE html>
<html lang="zh-Hant">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>更新商品｜MatchMarket</title>
  <link rel="stylesheet" href="css/header.css" />
  <link rel="stylesheet" href="css/edit_product.css" />
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet" />

</head>

<body>

  <header class="header">
    <!-- Logo 區 -->
    <div class="header__logo">
      <a href="/">
        <img src="../../img/logoText.png" alt="Logo" />
      </a>
    </div>

    <!-- 導覽列 -->
    <nav class="header__nav">
      <ul class="header__list">
        <li class="header__item"><a href="#">配對</a></li>
        <li class="header__item"><a href="#">聊天室</a></li>
        <li class="header__item"><a href="#">活動</a></li>
        <li class="header__item"><a href="#">討論區</a></li>

        <!-- 🔽 MatchMarket Dropdown -->
        <li class="header__item dropdown">
          <a href="select_page.html">MatchMarket</a>
          <ul class="dropdown-menu">
            <li><a href="select_page.html">看一下商品</a></li>
            <li class="dropdown-submenu">
              <a href="product_manager.html">My MatchMarket</a>
              <ul class="dropdown-menu">
                <li><a href="add_product.html">上架商品</a></li>
                <li><a href="#">已購賣商品</a></li>
              </ul>
            </li>
          </ul>
        </li>

        <li class="header__item"><a href="#">會員專區</a></li>
      </ul>
    </nav>

    <!-- 使用者圖示 -->
    <div class="header__user">
      <i class="fa-solid fa-user"></i>
    </div>
  </header>

  <main class="form-wrapper">
    <div class="form-header-row">
      <h1>更新商品</h1>
      <div class="form-group status-group">
        <label>商品狀態：</label>
        <span id="prodStatusDisplay" class="status-text">載入中...</span>
      </div>
    </div>

    <form class="form-layout" method="post" action="http://localhost:8087/api/ShShop/updateProd"
      enctype="multipart/form-data">
      <input type="hidden" id="prodId" name="prodId" value="">

      <!-- ✅ 基本資料 -->
      <section class="form-section">
        <div class="form-label-col">
          <p>基本資訊</p>
        </div>
        <div class="form-input-col">

          <div class="form-group">
            <label>商品名稱：</label>
            <input type="text" name="prodName" placeholder="請輸入商品名稱">
            <div class="error-msg" id="prodNameError"></div>
          </div>

          <div class="form-group">
            <label>品牌：</label>
            <input type="text" name="prodBrand" placeholder="請輸入品牌名稱">
            <div class="error-msg" id="prodBrandError"></div>
          </div>

          <div class="form-group">
            <label>商品分類：</label>
            <select name="prodTypeId">
              <option value="">請選擇分類</option>
            </select>
            <div class="error-msg" id="prodTypeIdError"></div>
          </div>

          <div class="form-row -number">
            <div class="form-group">
              <label>價格：</label>
              <input type="number" name="prodPrice" placeholder="單位：元">
              <div class="error-msg" id="prodPriceError"></div>
            </div>

            <div class="form-group">
              <label>數量：</label>
              <input type="number" name="prodCount" value="1" placeholder="預設為 1">
              <div class="error-msg" id="prodCountError"></div>
            </div>
          </div>

          <div class="form-group">
            <label>簡要描述：</label>
            <textarea name="prodContent" rows="4" placeholder="請輸入商品簡介..."></textarea>
            <div class="error-msg" id="prodContentError"></div>
          </div>
        </div>
      </section>

      <!-- ✅ 圖片 -->
      <section class="form-section">
        <div class="form-label-col">
          <p>圖片</p>
        </div>
        <div class="form-input-col">
          <div class="form-group">
            <label>商品圖片（最多 5 張，建議尺寸：800x800）：</label>
            <div class="image-preview-row" id="existingPreviewContainer">
              <!-- 原圖預覽容器 -->
            </div>
            <input type="file" id="prodImageInput" name="prodImage" accept="image/*" multiple>
          </div>
        </div>
      </section>

      <!-- ✅ 商品說明 -->
      <section class="form-section">
        <div class="form-label-col">
          <p>商品說明</p>
        </div>
        <div class="form-input-col">
          <label>商品狀況說明：</label>
          <textarea name="prodStatusDesc" rows="5" placeholder="例如：二手良品、九成新、未拆封等..."></textarea>
          <div class="error-msg" id="prodStatusDescError"></div>
        </div>
      </section>

      <!-- ✅ 按鈕 -->
      <div class="button-row">
        <input type="hidden" name="action" value="updateProd" />
        <button type="reset" class="discard">重設</button>
        <button type="submit" class="save">儲存變更</button>
      </div>
    </form>
  </main>

  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>
  <script src="js/shshopType.js">  </script>

<script>
  document.addEventListener("DOMContentLoaded", function () {
    const prodId = localStorage.getItem("editingProdId");
    const prodStatus = localStorage.getItem("prodStatus");
    const form = document.querySelector(".form-layout");
    const statusSpan = document.getElementById("prodStatusDisplay");
    const prodIdInput = document.getElementById("prodId");
    const previewContainer = document.getElementById("existingPreviewContainer");
    const removedPicUrls = [];

    if (statusSpan) statusSpan.innerText = prodStatus || "未提供";
    if (prodId && prodIdInput) prodIdInput.value = prodId;

    // 初始化載入商品資料
    const initFormData = new FormData();
    initFormData.append("id", prodId);

    fetch("http://localhost:8087/api/ShShop/getProd", {
      method: "POST",
      body: initFormData
    })
      .then(res => res.json())
      .then(data => {
        const prod = data.data;
        if (!prod) throw new Error("找不到商品資料");

        form.prodName.value = prod.prodName;
        form.prodBrand.value = prod.prodBrand;
        form.prodPrice.value = prod.prodPrice;
        form.prodCount.value = prod.prodCount;
        form.prodContent.value = prod.prodContent;
        form.prodStatusDesc.value = prod.prodDesc;

        const select = form.prodTypeId;
        const timer = setInterval(() => {
          if (select.options.length > 1) {
            select.value = prod.prodTypeId?.toString();
            clearInterval(timer);
          }
        }, 100);


        previewContainer.innerHTML = "";
        prod.picUrls.forEach((url, idx) => {
          const imgBox = document.createElement("div");
          imgBox.classList.add("img-box", "original-img");
          imgBox.innerHTML = `
            <div class="img-wrapper">
              <img src="${url}" alt="圖片${idx + 1}" />
              <button type="button" class="delete-btn" data-url="${url}">&times;</button>
            </div>
          `;
          previewContainer.appendChild(imgBox);
        });
      })
      .catch(err => {
        alert("無法載入商品資料，請稍後再試");
        console.error(err);
      });

    // 刪除圖片按鈕
    previewContainer.addEventListener("click", function (e) {
      if (e.target.classList.contains("delete-btn")) {
        const imgBox = e.target.closest(".img-box");
        const url = e.target.getAttribute("data-url");
        if (url && !removedPicUrls.includes(url)) {
          removedPicUrls.push(url);
        }
        if (imgBox) imgBox.remove();
      }
    });

    // 圖片預覽（但不清除 file input）
    const fileInput = form.querySelector('input[name="prodImage"]');
    fileInput.addEventListener("change", function () {
      const files = Array.from(fileInput.files);
      const currentCount = previewContainer.querySelectorAll(".img-box").length;
      const availableSlots = 5 - currentCount;

      if (availableSlots <= 0) {
        alert("最多只能上傳 5 張圖片！");
        return;
      }

      const filesToAdd = files.slice(0, availableSlots);
      filesToAdd.forEach((file, idx) => {
        const reader = new FileReader();
        reader.onload = e => {
          const imgBox = document.createElement("div");
          imgBox.classList.add("img-box", "new-upload");
          imgBox.innerHTML = `
            <div class="img-wrapper">
              <img src="${e.target.result}" alt="新圖片${idx + 1}" />
              <button type="button" class="delete-btn">&times;</button>
            </div>
          `;
          previewContainer.appendChild(imgBox);
        };
        reader.readAsDataURL(file);
      });

      // ❌ 不要清空 fileInput，否則 multipart 就送不出
      // fileInput.value = "";
    });

    // 表單送出
    form.addEventListener("submit", function (e) {
      e.preventDefault();
      form.querySelectorAll(".error-msg").forEach(el => (el.innerText = ""));

      const submitData = new FormData(form);

      // 加入原圖中保留的 picUrls（後端會 append 到新增圖片後）
      const keptUrls = [];
      previewContainer.querySelectorAll(".original-img img").forEach(img => {
        const url = img.getAttribute("src");
        if (!removedPicUrls.includes(url)) {
          keptUrls.push(url);
        }
      });
      keptUrls.forEach(url => {
        submitData.append("picUrls", url);
      });

      // 額外保險加上 prodId、prodTypeId
      submitData.set("prodId", prodIdInput.value);
      submitData.set("prodTypeId", form.prodTypeId.value);

      // ✅ 除錯用 log，建議開啟
      for (const [key, value] of submitData.entries()) {
        console.log("FormData:", key, value);
      }

      fetch("http://localhost:8087/api/ShShop/updateProd", {
        method: "POST",
        body: submitData
      })
        .then(response => response.json().then(data => ({ status: response.status, body: data })))
        .then(({ status, body }) => {
          if (body.message === "success") {
            const updatedId = body.data?.prodId;
            if (updatedId) {
              window.location.href = `product_page.html?id=${updatedId}`;
            } else {
              alert("更新成功，但找不到商品編號！");
            }
          } else if (status === 400 && body.message === "validation_failed") {
            const errors = body.errors || {};
            for (const field in errors) {
              const errBox = document.getElementById(`${field}Error`);
              if (errBox) errBox.innerText = errors[field];
            }
          } else {
            alert("發生錯誤：" + (body.message || "請稍後再試"));
          }
        })
        .catch(error => {
          alert("商品更新失敗！");
          console.error(error);
        });
    });
  });

  window.addEventListener("beforeunload", () => {
    localStorage.removeItem("editingProdId");
    localStorage.removeItem("prodStatus");
  });
</script>





</body>

</html>