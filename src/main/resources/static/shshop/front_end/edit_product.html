<!DOCTYPE html>
<html lang="zh-Hant">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>æ›´æ–°å•†å“ï½œMatchMarket</title>
  <link rel="stylesheet" href="css/header.css" />
  <link rel="stylesheet" href="css/edit_product.css" />
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet" />

</head>

<body>

  <header class="header">
    <!-- Logo å€ -->
    <div class="header__logo">
      <a href="/">
        <img src="../../img/logoText.png" alt="Logo" />
      </a>
    </div>

    <!-- å°è¦½åˆ— -->
    <nav class="header__nav">
      <ul class="header__list">
        <li class="header__item"><a href="#">é…å°</a></li>
        <li class="header__item"><a href="#">èŠå¤©å®¤</a></li>
        <li class="header__item"><a href="#">æ´»å‹•</a></li>
        <li class="header__item"><a href="#">è¨è«–å€</a></li>

        <!-- ğŸ”½ MatchMarket Dropdown -->
        <li class="header__item dropdown">
          <a href="select_page.html">MatchMarket</a>
          <ul class="dropdown-menu">
            <li><a href="select_page.html">çœ‹ä¸€ä¸‹å•†å“</a></li>
            <li class="dropdown-submenu">
              <a href="product_manager.html">My MatchMarket</a>
              <ul class="dropdown-menu">
                <li><a href="add_product.html">ä¸Šæ¶å•†å“</a></li>
                <li><a href="#">å·²è³¼è³£å•†å“</a></li>
              </ul>
            </li>
          </ul>
        </li>

        <li class="header__item"><a href="#">æœƒå“¡å°ˆå€</a></li>
      </ul>
    </nav>

    <!-- ä½¿ç”¨è€…åœ–ç¤º -->
    <div class="header__user">
      <i class="fa-solid fa-user"></i>
    </div>
  </header>

  <main class="form-wrapper">
    <div class="form-header-row">
      <h1>æ›´æ–°å•†å“</h1>
      <div class="form-group status-group">
        <label>å•†å“ç‹€æ…‹ï¼š</label>
        <span id="prodStatusDisplay" class="status-text">è¼‰å…¥ä¸­...</span>
      </div>
    </div>

    <form class="form-layout" method="post" action="http://localhost:8087/api/ShShop/updateProd"
      enctype="multipart/form-data">
      <input type="hidden" id="prodId" name="prodId" value="">

      <!-- âœ… åŸºæœ¬è³‡æ–™ -->
      <section class="form-section">
        <div class="form-label-col">
          <p>åŸºæœ¬è³‡è¨Š</p>
        </div>
        <div class="form-input-col">

          <div class="form-group">
            <label>å•†å“åç¨±ï¼š</label>
            <input type="text" name="prodName" placeholder="è«‹è¼¸å…¥å•†å“åç¨±">
            <div class="error-msg" id="prodNameError"></div>
          </div>

          <div class="form-group">
            <label>å“ç‰Œï¼š</label>
            <input type="text" name="prodBrand" placeholder="è«‹è¼¸å…¥å“ç‰Œåç¨±">
            <div class="error-msg" id="prodBrandError"></div>
          </div>

          <div class="form-group">
            <label>å•†å“åˆ†é¡ï¼š</label>
            <select name="prodTypeId">
              <option value="">è«‹é¸æ“‡åˆ†é¡</option>
            </select>
            <div class="error-msg" id="prodTypeIdError"></div>
          </div>

          <div class="form-row -number">
            <div class="form-group">
              <label>åƒ¹æ ¼ï¼š</label>
              <input type="number" name="prodPrice" placeholder="å–®ä½ï¼šå…ƒ">
              <div class="error-msg" id="prodPriceError"></div>
            </div>

            <div class="form-group">
              <label>æ•¸é‡ï¼š</label>
              <input type="number" name="prodCount" value="1" placeholder="é è¨­ç‚º 1">
              <div class="error-msg" id="prodCountError"></div>
            </div>
          </div>

          <div class="form-group">
            <label>ç°¡è¦æè¿°ï¼š</label>
            <textarea name="prodContent" rows="4" placeholder="è«‹è¼¸å…¥å•†å“ç°¡ä»‹..."></textarea>
            <div class="error-msg" id="prodContentError"></div>
          </div>
        </div>
      </section>

      <!-- âœ… åœ–ç‰‡ -->
      <section class="form-section">
        <div class="form-label-col">
          <p>åœ–ç‰‡</p>
        </div>
        <div class="form-input-col">
          <div class="form-group">
            <label>å•†å“åœ–ç‰‡ï¼ˆæœ€å¤š 5 å¼µï¼Œå»ºè­°å°ºå¯¸ï¼š800x800ï¼‰ï¼š</label>
            <div class="image-preview-row" id="existingPreviewContainer">
              <!-- åŸåœ–é è¦½å®¹å™¨ -->
            </div>
            <input type="file" id="prodImageInput" name="prodImage" accept="image/*" multiple>
          </div>
        </div>
      </section>

      <!-- âœ… å•†å“èªªæ˜ -->
      <section class="form-section">
        <div class="form-label-col">
          <p>å•†å“èªªæ˜</p>
        </div>
        <div class="form-input-col">
          <label>å•†å“ç‹€æ³èªªæ˜ï¼š</label>
          <textarea name="prodStatusDesc" rows="5" placeholder="ä¾‹å¦‚ï¼šäºŒæ‰‹è‰¯å“ã€ä¹æˆæ–°ã€æœªæ‹†å°ç­‰..."></textarea>
          <div class="error-msg" id="prodStatusDescError"></div>
        </div>
      </section>

      <!-- âœ… æŒ‰éˆ• -->
      <div class="button-row">
        <input type="hidden" name="action" value="updateProd" />
        <button type="reset" class="discard">é‡è¨­</button>
        <button type="submit" class="save">å„²å­˜è®Šæ›´</button>
      </div>
    </form>
  </main>

  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>
  <script src="js/shshopType.js">  </script>

<script>
document.addEventListener("DOMContentLoaded", () => {
  const prodId = localStorage.getItem("editingProdId");
  const prodStatus = localStorage.getItem("prodStatus");

  const form = document.querySelector(".form-layout");
  const statusSpan = document.getElementById("prodStatusDisplay");
  const prodIdInput = document.getElementById("prodId");
  const previewContainer = document.getElementById("existingPreviewContainer");
  const fileInput = form.querySelector('input[name="prodImage"]');
  const removedPicUrls = [];

  if (statusSpan) statusSpan.innerText = prodStatus || "æœªæä¾›";
  if (prodId && prodIdInput) prodIdInput.value = prodId;

  // åˆå§‹åŒ–è¼‰å…¥å•†å“è³‡æ–™
  loadProductData();

  function loadProductData() {
    const initFormData = new FormData();
    initFormData.append("id", prodId);

    fetch("http://localhost:8087/api/ShShop/getProd", {
      method: "POST",
      body: initFormData
    })
      .then(res => res.json())
      .then(data => {
        const prod = data.data;
        if (!prod) throw new Error("æ‰¾ä¸åˆ°å•†å“è³‡æ–™");

        fillFormFields(prod);
        renderOriginalImages(prod.picUrls);
        selectProductTypeAfterOptionsReady(prod.prodTypeId);
      })
      .catch(err => {
        alert("ç„¡æ³•è¼‰å…¥å•†å“è³‡æ–™ï¼Œè«‹ç¨å¾Œå†è©¦");
        console.error(err);
      });
  }

  function fillFormFields(prod) {
    form.prodName.value = prod.prodName;
    form.prodBrand.value = prod.prodBrand;
    form.prodPrice.value = prod.prodPrice;
    form.prodCount.value = prod.prodCount;
    form.prodContent.value = prod.prodContent;
    form.prodStatusDesc.value = prod.prodDesc;
  }

  function selectProductTypeAfterOptionsReady(prodTypeId) {
    const select = form.prodTypeId;
    const timer = setInterval(() => {
      if (select.options.length > 1) {
        select.value = prodTypeId?.toString();
        clearInterval(timer);
      }
    }, 100);
  }

  function renderOriginalImages(picUrls) {
    previewContainer.innerHTML = "";
    picUrls.forEach((url, idx) => {
      const imgBox = document.createElement("div");
      imgBox.classList.add("img-box", "original-img");
      imgBox.innerHTML = `
        <div class="img-wrapper">
          <img src="${url}" alt="åœ–ç‰‡${idx + 1}" />
          <button type="button" class="delete-btn" data-url="${url}">&times;</button>
        </div>
      `;
      previewContainer.appendChild(imgBox);
    });
  }

  // åˆªé™¤åœ–ç‰‡ï¼ˆåŸåœ–è¨˜éŒ„ URLï¼Œæ–°å¢åœ–ç›´æ¥åˆª DOMï¼‰
  previewContainer.addEventListener("click", (e) => {
    if (!e.target.classList.contains("delete-btn")) return;

    const imgBox = e.target.closest(".img-box");
    const url = e.target.getAttribute("data-url");
    if (url && !removedPicUrls.includes(url)) {
      removedPicUrls.push(url);
    }
    if (imgBox) imgBox.remove();
  });

  // æ–°åœ–é è¦½ï¼ˆä¸æ¸…ç©º inputï¼‰
  fileInput.addEventListener("change", () => {
    const files = Array.from(fileInput.files);
    const currentCount = previewContainer.querySelectorAll(".img-box").length;
    const availableSlots = 5 - currentCount;

    if (availableSlots <= 0) {
      alert("æœ€å¤šåªèƒ½ä¸Šå‚³ 5 å¼µåœ–ç‰‡ï¼");
      return;
    }

    const filesToAdd = files.slice(0, availableSlots);
    filesToAdd.forEach((file, idx) => {
      const reader = new FileReader();
      reader.onload = e => {
        const imgBox = document.createElement("div");
        imgBox.classList.add("img-box", "new-upload");
        imgBox.innerHTML = `
          <div class="img-wrapper">
            <img src="${e.target.result}" alt="æ–°åœ–ç‰‡${idx + 1}" />
            <button type="button" class="delete-btn">&times;</button>
          </div>
        `;
        previewContainer.appendChild(imgBox);
      };
      reader.readAsDataURL(file);
    });
  });

  // è¡¨å–®é€å‡ºé‚è¼¯
  form.addEventListener("submit", (e) => {
    e.preventDefault();
    clearAllErrors();

    const submitData = new FormData(form);

    // åŠ å…¥ä¿ç•™çš„åŸåœ– URL
    previewContainer.querySelectorAll(".original-img img").forEach(img => {
      const url = img.getAttribute("src");
      if (!removedPicUrls.includes(url)) {
        submitData.append("picUrls", url);
      }
    });

    // åŠ å…¥è¢«åˆªé™¤çš„åœ–ç‰‡ URLï¼ˆå¾Œç«¯å¯é¸æ“‡è™•ç†ï¼‰
    removedPicUrls.forEach(url => {
      submitData.append("removedPicUrls", url);
    });

    // å†è£œ prodId/prodTypeIdï¼ˆå®‰å…¨ä¿éšªï¼‰
    submitData.set("prodId", prodIdInput.value);
    submitData.set("prodTypeId", form.prodTypeId.value);

    // é™¤éŒ¯ log
    for (const [key, value] of submitData.entries()) {
      console.log("FormData:", key, value);
    }

    // ç™¼é€æ›´æ–°è«‹æ±‚
    fetch("http://localhost:8087/api/ShShop/updateProd", {
      method: "POST",
      body: submitData
    })
      .then(response => response.json().then(data => ({ status: response.status, body: data })))
      .then(({ status, body }) => {
        if (body.message === "success") {
          const updatedId = body.data?.prodId;
          window.location.href = updatedId ? `product_page.html?id=${updatedId}` : "/";
        } else if (status === 400 && body.message === "validation_failed") {
          showValidationErrors(body.errors);
        } else {
          alert("ç™¼ç”ŸéŒ¯èª¤ï¼š" + (body.message || "è«‹ç¨å¾Œå†è©¦"));
        }
      })
      .catch(error => {
        alert("å•†å“æ›´æ–°å¤±æ•—ï¼");
        console.error(error);
      });
  });

  function clearAllErrors() {
    form.querySelectorAll(".error-msg").forEach(el => (el.innerText = ""));
  }

  function showValidationErrors(errors = {}) {
    for (const field in errors) {
      const errBox = document.getElementById(`${field}Error`);
      if (errBox) errBox.innerText = errors[field];
    }
  }
});

// æ¸…é™¤ localStorage ä¸­çš„æš«å­˜ç‹€æ…‹
window.addEventListener("beforeunload", () => {
  localStorage.removeItem("editingProdId");
  localStorage.removeItem("prodStatus");
});
</script>






</body>

</html>