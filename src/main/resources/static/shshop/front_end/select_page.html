<!DOCTYPE html>

<html lang="zh-Hant">

<head>
  <meta charset="utf-8" />
  <meta content="width=device-width, initial-scale=1.0" name="viewport" />
  <title>MatchMarket</title>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet" />
  <link rel="stylesheet" href="css/header.css" />
  <link rel="stylesheet" href="css/select_page.css" />

</head>

<body>
  <header class="header">
    <!-- Logo å€ -->
    <div class="header__logo">
      <a href="/">
        <img src="../../img/logoText.png" alt="Logo" />
      </a>
    </div>

    <!-- å°è¦½åˆ— -->
    <nav class="header__nav">
      <ul class="header__list">
        <li class="header__item"><a href="#">é…å°</a></li>
        <li class="header__item"><a href="#">èŠå¤©å®¤</a></li>
        <li class="header__item"><a href="#">æ´»å‹•</a></li>
        <li class="header__item"><a href="#">è¨è«–å€</a></li>

        <!-- ğŸ”½ MatchMarket Dropdown -->
        <li class="header__item dropdown">
          <a href="#">MatchMarket</a>
          <ul class="dropdown-menu">
            <li><a href="#">çœ‹ä¸€ä¸‹å•†å“</a></li>
            <li class="dropdown-submenu">
              <a href="#">My MatchMarket</a>
              <ul class="dropdown-menu">
                <li><a href="add_product.html">ä¸Šæ¶å•†å“</a></li>
                <li><a href="#">å·²è³¼è³£å•†å“</a></li>
              </ul>
            </li>
          </ul>
        </li>

        <li class="header__item"><a href="#">æœƒå“¡å°ˆå€</a></li>
      </ul>
    </nav>

    <!-- ä½¿ç”¨è€…åœ–ç¤º -->
    <div class="header__user">
      <i class="fa-solid fa-user"></i>
    </div>
  </header>


  <div class="sidebar-wrapper">
    <div class="sidebar" id="sidebar">
      <button class="menu-toggle" id="menuToggle" onclick="toggleSidebar()">
        <i class="fa-solid fa-bars"></i>
      </button>
      <ul>
        <li><i class="fa-solid fa-user"></i> æœƒå“¡ä¸­å¿ƒ</li>
        <li><i class="fa-solid fa-store"></i> èŠèŠå•†åŸ</li>
        <li><i class="fa-solid fa-headset"></i> å®¢æœä¸­å¿ƒ</li>
        <li><i class="fa-solid fa-gear"></i> è¨­å®š</li>
      </ul>
    </div>
  </div>

  <aside class="aside">
    <nav class="nav">
      <ul class="nav_list">
        <li><a href="#">å•†å“é¡åˆ¥</a></li>
      </ul>
    </nav>
    <form class="advanced-search" id="advSearchForm">
      <h4>é€²éšæœå°‹</h4>

      <input type="text" name="prodName" placeholder="å•†å“åé—œéµå­—" />
      <input type="text" name="prodBrand" placeholder="å“ç‰Œé—œéµå­—" />
      <input type="text" name="prodContent" placeholder="å•†å“å…§å®¹é—œéµå­—" />
      <select name="typeId" id="advTypeSelect">
        <option value="">æ‰€æœ‰é¡åˆ¥</option>
        <!-- JS å‹•æ…‹è¼‰å…¥ -->
      </select>

      <div class="price-range">
        <input type="number" name="minPrice" placeholder="æœ€ä½åƒ¹" />
        <span>~</span>
        <input type="number" name="maxPrice" placeholder="æœ€é«˜åƒ¹" />
      </div>

      <input type="text" name="username" placeholder="ä¸Šæ¶è€…å¸³è™Ÿ" />

      <button type="submit">æœå°‹</button>
      <button type="button" id="clearBtn">æ¸…ç©º</button>
    </form>
  </aside>

  <div class="search-bar">
    <input id="keywordInput" type="text" placeholder="è¼¸å…¥å•†å“é—œéµå­—" />
    <button id="searchBtn"><i class="fa fa-search"></i></button>
    <div class="sort-buttons">
      <button class="sort-btn">åƒ¹æ ¼ â†‘</button>
      <button class="sort-btn">åƒ¹æ ¼ â†“</button>
      <button class="sort-btn">æœ€æ–°</button>
      <button class="sort-btn">æœ€èˆŠ</button>
    </div>
  </div>

  <main class="main">
    <ul class="item_list">
      ç›®å‰æ²’æœ‰å¥½å‹æœ‰å•†å“ï¼Œé…å°é€£çµ<a href="#"></a>
    </ul>
  </main>



  <!-- âœ… æµ®å‹•å¥½å‹æ¸…å–® -->
  <div class="friend-floating collapsed">
    <button class="toggle-friend-btn"><i class="fa fa-chevron-down"></i></button>
    <div class="friend-panel">
      <h3 class="friend-title">å¥½å‹æ¸…å–®</h3>
      <ul class="friend-list"></ul>
    </div>
  </div>
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>
  <script>
    // å…¨åŸŸè®Šæ•¸
    const navList = $(".nav_list");
    const itemList = $(".item_list");
    const friendList = $(".friend-floating .friend-list");

    // å•†å“ HTML æ¨¡æ¿
    function renderProductItem(prod) {
      const imgSrc = prod.picUrls?.[0] || "https://placehold.co/400x300";
      return `
    <li>
      <a href="product_page.html?id=${prod.prodId}">
        <div class="img_block">
          <img class="product_img" src="${imgSrc}" alt="${prod.prodName}">
        </div>
        <div class="item_text">
          <div class="prod-info">
            <div class="prod-name">${prod.prodName}</div>
            <div class="prod-brand">${prod.prodBrand}</div>
            <div class="prod-type">${prod.prodTypeName}</div>
            <div class="prod-price">NT$${prod.prodPrice}</div>
          </div>
          <small class="owner">ä¸Šæ¶è€…ï¼š${prod.userName}</small>
        </div>
      </a>
    </li>`;
    }

    function showError(message) {
      itemList.html(`<li>${message}</li>`);
    }

    function loadTypes() {
      $.ajax({
        url: "http://localhost:8087/api/ShShop/allTypes",
        method: "GET",
        dataType: "json",
        success: function (response) {
          if (!response.data) return showError("é¡åˆ¥è¼‰å…¥å¤±æ•—");

          navList.empty();
          navList.append(`<li><a href="#" class="active" data-type-id="">æ‰€æœ‰å•†å“</a></li>`);

          response.data.forEach(type => {
            navList.append(`<li><a href="#" data-type-id="${type.prodTypeId}">${type.prodTypeName}</a></li>`);
          });
        },
        error: function (xhr) {
          const msg = xhr.responseJSON?.message || "è¼‰å…¥åˆ†é¡å¤±æ•—";
          showError(msg);
        }
      });
    }

    function loadProducts(typeId = "") {
      const url = typeId
        ? `http://localhost:8087/api/ShShop/getProdsByType?typeId=${typeId}`
        : `http://localhost:8087/api/ShShop/getProds`;

      $.ajax({
        url,
        method: "GET",
        dataType: "json",
        success: function (res) {
          itemList.empty();
          if (!res.data || res.data.length === 0) {
            return showError("ç›®å‰æ²’æœ‰å•†å“");
          }
          res.data.forEach(prod => itemList.append(renderProductItem(prod)));
        },
        error: function (xhr) {
          const msg = xhr.responseJSON?.message || "è¼‰å…¥å•†å“å¤±æ•—";
          showError(msg);
        }
      });
    }

    function loadSortedProducts(ord) {
      $.ajax({
        url: `http://localhost:8087/api/ShShop/getProdsOrd?ord=${ord}`,
        method: "GET",
        dataType: "json",
        success: function (res) {
          itemList.empty();
          if (!res.data || res.data.length === 0) {
            return showError("ç›®å‰æ²’æœ‰å•†å“");
          }
          res.data.forEach(prod => itemList.append(renderProductItem(prod)));
        },
        error: function (xhr) {
          const msg = xhr.responseJSON?.message || "è¼‰å…¥æ’åºå•†å“å¤±æ•—";
          showError(msg);
        }
      });
    }

    function searchProducts(keyword) {
      if (!keyword) return;

      $.ajax({
        url: `http://localhost:8087/api/ShShop/keyWord?keyStr=${encodeURIComponent(keyword)}`,
        method: "GET",
        dataType: "json",
        success: function (res) {
          itemList.empty();
          if (!res.data || res.data.length === 0) {
            return showError("æ‰¾ä¸åˆ°ç›¸é—œå•†å“");
          }
          res.data.forEach(prod => itemList.append(renderProductItem(prod)));
        },
        error: function (xhr) {
          const msg = xhr.responseJSON?.message || "æœå°‹å¤±æ•—";
          showError(msg);
        }
      });
    }

    function loadFriends() {
      $.ajax({
        url: "http://localhost:8087/api/ShShop/friendList",
        method: "GET",
        dataType: "json",
        success: function (res) {
          friendList.empty();
          if (!res.data || res.data.length === 0) {
            return friendList.append(`<li>ç›®å‰æ²’æœ‰å¥½å‹</li>`);
          }

          res.data.forEach(friend => {
            const friendHTML = `
          <li data-id="${friend.userId}">
            <img class="friend-avatar" src="${friend.img1}" alt="${friend.username}">
            <span>${friend.username}</span>
          </li>`;
            friendList.append(friendHTML);
          });

          friendList.on("click", "li", function () {
            const friendId = $(this).data("id");
            $.ajax({
              url: `http://localhost:8087/api/ShShop/getProdsByUser?userId=${friendId}`,
              method: "POST",
              dataType: "json",
              success: function (res) {
                itemList.empty();
                if (!res.data || res.data.length === 0) {
                  return showError("è©²å¥½å‹å°šæœªä¸Šæ¶å•†å“");
                }
                res.data.forEach(prod => itemList.append(renderProductItem(prod)));
              },
              error: function (xhr) {
                const msg = xhr.responseJSON?.message || "è¼‰å…¥å¥½å‹å•†å“å¤±æ•—";
                showError(msg);
              }
            });
          });
        },
        error: function (xhr) {
          const msg = xhr.responseJSON?.message || "è¼‰å…¥å¥½å‹æ¸…å–®å¤±æ•—";
          showError(msg);
        }
      });
    }

    // ç¶å®šäº‹ä»¶
    $(document).ready(function () {
      loadTypes();
      loadProducts();
      loadFriends();

      navList.on("click", "a", function (e) {
        e.preventDefault();
        const selectedTypeId = $(this).data("type-id");
        navList.find("a").removeClass("active");
        $(this).addClass("active");
        loadProducts(selectedTypeId);
      });

      $(".sort-buttons").on("click", ".sort-btn", function () {
        const text = $(this).text();
        let ord = "";
        if (text.includes("â†‘")) ord = "pa";
        else if (text.includes("â†“")) ord = "pd";
        else if (text.includes("æœ€æ–°")) ord = "ta";
        else if (text.includes("æœ€èˆŠ")) ord = "td";
        loadSortedProducts(ord);

      });

      $("#searchBtn").on("click", function () {
        const keyword = $("#keywordInput").val().trim();
        searchProducts(keyword);
      });

      $(".toggle-friend-btn").on("click", function () {
        const panel = $(".friend-floating");
        panel.toggleClass("collapsed");

        // åˆ‡æ›ç®­é ­æ–¹å‘ï¼šdown / up
        const icon = $(this).find("i");
        icon.toggleClass("fa-chevron-down fa-chevron-up");
      });

      // è¼‰å…¥é¡åˆ¥ä¸‹æ‹‰é¸å–®
      function populateAdvancedTypeSelect() {
        $.get("http://localhost:8087/api/ShShop/allTypes", function (res) {
          const select = $("#advTypeSelect");
          res.data.forEach(t => {
            select.append(`<option value="${t.prodTypeId}">${t.prodTypeName}</option>`);
          });
        });
      }

      $("#advSearchForm").on("submit", function (e) {
        e.preventDefault(); // é˜»æ­¢è¡¨å–®é è¨­æäº¤è¡Œç‚º

        const formData = $(this).serialize(); // å°‡æ‰€æœ‰æ¬„ä½è½‰ç‚º URL encoded æ ¼å¼
        console.log("é€²éšæœå°‹è³‡æ–™:", formData);
        $.ajax({
          url: "http://localhost:8087/api/ShShop/advanceSearch", // å‡è¨­é€™æ˜¯å¾Œç«¯ endpoint
          method: "POST",
          data: formData,
          dataType: "json",
          success: function (res) {
            itemList.empty();
            if (!res.data || res.data.length === 0) {
              return showError("æ‰¾ä¸åˆ°ç¬¦åˆçš„å•†å“");
            }
            res.data.forEach(prod => itemList.append(renderProductItem(prod)));
          },
          error: function (xhr) {
            const msg = xhr.responseJSON?.message || "æœå°‹å¤±æ•—";
            showError(msg);
          }
        });
      });

      populateAdvancedTypeSelect();

      $("#clearBtn").on("click", function () {
        $("#advSearchForm").find("input[type='text'], input[type='number'], select").val("");
        loadProducts(); // é‡æ–°è¼‰å…¥æ‰€æœ‰å•†å“
      });

    });


  </script>
</body>

</html>