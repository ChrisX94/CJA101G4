<!DOCTYPE html>
<html lang="zh-Hant">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>My MatchMarket</title>
    <link rel="stylesheet" href="css/header.css" />
    <link rel="stylesheet" href="css/product_manager.css" />

    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet" />


</head>

<body>
    <header class="header">
        <div class="header__logo">
            <a href="/">
                <img src="../../img/logoText.png" alt="Logo" />
            </a>
        </div>

        <nav class="header__nav">
            <ul class="header__list">
                <li class="header__item"><a href="#">é…å°</a></li>
                <li class="header__item"><a href="#">èŠå¤©å®¤</a></li>
                <li class="header__item"><a href="#">æ´»å‹•</a></li>
                <li class="header__item"><a href="#">è¨è«–å€</a></li>

                <li class="header__item dropdown">
                    <a href="select_page.html">MatchMarket</a>
                    <ul class="dropdown-menu">
                        <li><a href="select_page.html">çœ‹ä¸€ä¸‹å•†å“</a></li>
                        <li class="dropdown-submenu">
                            <a href="product_manager.html">My MatchMarket</a>
                            <ul class="dropdown-menu">
                                <li><a href="add_product.html">ä¸Šæ¶å•†å“</a></li>
                                <li><a href="#">å·²è³¼è³£å•†å“</a></li>
                            </ul>
                        </li>
                    </ul>
                </li>

                <li class="header__item"><a href="#">æœƒå“¡å°ˆå€</a></li>
            </ul>
        </nav>

        <div class="header__user">
            <i class="fa-solid fa-user"></i>
        </div>
    </header>


    <div class="sidebar">
        <h3 class="sidebar-title">å•†å“ç®¡ç†</h3>
        <a href="#" id="view-all-btn" class="active sidebar-item">å…¨éƒ¨å•†å“</a>
        <a href="#" id="view-on-depending" class="sidebar-item">æŸ¥çœ‹å¯©æ ¸ç‹€æ…‹</a>
        <a href="#" id="view-on-sale-btn" class="sidebar-item">å·²ä¸Šæ¶å•†å“</a>
        <a href="#" id="view-on-delist-btn" class="sidebar-item">å·²ä¸‹æ¶å•†å“</a>
    </div>

    <div class="main-content">
        <div class="page-title-container">
            <h1 class="page-title">æˆ‘çš„å•†å“</h1>
        </div>

        <div class="table-container">
            <table>
                <thead>
                    <tr>
                        <th>å•†å“åœ–ç‰‡</th>
                        <th>å•†å“åç¨±</th>
                        <th>åƒ¹æ ¼</th>
                        <th>æ•¸é‡</th>
                        <th>æè¿°</th>
                        <th>å•†å“ç‹€æ…‹</th>
                        <th>æ“ä½œ</th>
                        <th>å¯©æ ¸æ‹’çµ•åŸå› </th>
                    </tr>
                </thead>
                <tbody>

                </tbody>
            </table>
        </div>
    </div>


    <script>
        function goToEdit(prodId, prodStatus) {
            localStorage.setItem("editingProdId", prodId);
            localStorage.setItem("prodStatus", prodStatus);
            window.location.href = "edit_product.html";
        }

        // åŸå§‹è¼‰å…¥å…¨éƒ¨å•†å“ï¼ˆç™»å…¥è€…çš„ï¼‰
        document.addEventListener("DOMContentLoaded", function () {
            loadAllProducts(); // é è¨­è¼‰å…¥æ‰€æœ‰å•†å“
            // åˆå§‹åŒ–å´é‚Šæ¬„æŒ‰éˆ•çš„ active ç‹€æ…‹
            document.querySelectorAll('.sidebar-item').forEach(item => {
                item.classList.remove('active');
            });
            document.getElementById('view-all-btn').classList.add('active');
        });

        function loadAllProducts() {
            fetch("http://localhost:8087/api/ShShop/myProds", {
                method: "POST",
                headers: {
                    "Content-Type": "application/x-www-form-urlencoded"
                },
                body: new URLSearchParams({
                    action: "all" // é€™è£¡å¯ä»¥æ ¹æ“šéœ€è¦èª¿æ•´æŸ¥è©¢æ¢ä»¶
                })
            })
                .then(res => res.json())
                .then(res => {
                    if (!res || !res.data || !Array.isArray(res.data)) {
                        console.error("å›å‚³æ ¼å¼éŒ¯èª¤", res);
                        return;
                    }

                    const tbody = document.querySelector("tbody");
                    tbody.innerHTML = ""; // æ¸…ç©ºåŸæœ‰è³‡æ–™

                    if (res.data.length === 0) {
                        tbody.innerHTML = "<tr><td colspan='7'>ç›®å‰æ²’æœ‰ä»»ä½•å•†å“</td></tr>";
                        return;
                    }

                    res.data.forEach(prod => {
                        const firstImg = prod.picUrls?.[0] || "https://via.placeholder.com/60";
                        if (prod.rejectReason == null) {
                            prod.rejectReason = "";
                        }
                        const tr = document.createElement("tr");
                        tr.innerHTML = `
                        <td><img class="prod-img" src="${firstImg}" alt="å•†å“åœ–ç‰‡" /></td>
                        <td>${prod.prodName}</td>
                        <td>$${prod.prodPrice}</td>
                        <td>${prod.prodCount}</td>
                        <td>${prod.prodDesc}</td>
                        <td>${prod.prodStatusStr}</td>
                        <td>
                          <button type="button" class="material-button edit-btn" onclick="goToEdit(${prod.prodId}, '${prod.prodStatusStr}')">ä¿®æ”¹</button>
                        </td>
                        <td>${prod.rejectReason || ""}</td>
                    `;
                        tbody.appendChild(tr);
                    });
                })
                .catch(err => {
                    console.error("è¼‰å…¥å•†å“å¤±æ•—ï¼š", err);
                });
        }

        // é»é¸å´é‚Šæ¬„æŒ‰éˆ•æ™‚ï¼Œæ›´æ–° active ç‹€æ…‹ä¸¦è¼‰å…¥å°æ‡‰å•†å“
        document.querySelectorAll('.sidebar-item').forEach(button => {
            button.addEventListener('click', function (e) {
                e.preventDefault();
                document.querySelectorAll('.sidebar-item').forEach(item => {
                    item.classList.remove('active');
                });
                this.classList.add('active');

                // æ ¹æ“š ID å‘¼å«å°æ‡‰çš„è¼‰å…¥å‡½æ•¸
                if (this.id === 'view-all-btn') {
                    loadAllProducts();
                } else if (this.id === 'view-on-depending') {
                    loadOnPendingProducts();
                } else if (this.id === 'view-on-sale-btn') {
                    loadOnSaleProducts();
                } else if (this.id === 'view-on-delist-btn') {
                    loadOnDelistProducts();
                }
            });
        });


        function loadOnSaleProducts() {
            fetch("http://localhost:8087/api/ShShop/myProds", {
                method: "POST",
                headers: {
                    "Content-Type": "application/x-www-form-urlencoded"
                },
                body: new URLSearchParams({ action: "available" })
            })
                .then(res => res.json())
                .then(res => {
                    if (!res || !res.data || !Array.isArray(res.data)) {
                        console.error("å›å‚³æ ¼å¼éŒ¯èª¤", res);
                        return;
                    }

                    const tbody = document.querySelector("tbody");
                    tbody.innerHTML = "";

                    const onSale = res.data;

                    if (onSale.length === 0) {
                        tbody.innerHTML = "<tr><td colspan='7'>ç›®å‰æ²’æœ‰ä¸Šæ¶ä¸­çš„å•†å“</td></tr>";
                        return;
                    }

                    onSale.forEach(prod => {
                        const firstImg = prod.picUrls?.[0] || "https://via.placeholder.com/60";
                        const tr = document.createElement("tr");
                        if (prod.rejectReason == null) {
                            prod.rejectReason = "";
                        }

                        tr.innerHTML = `
                        <td><img class="prod-img" src="${firstImg}" alt="å•†å“åœ–ç‰‡" /></td>
                        <td>${prod.prodName}</td>
                        <td>$${prod.prodPrice}</td>
                        <td>${prod.prodCount}</td>
                        <td>${prod.prodDesc}</td>
                        <td>${prod.prodStatusStr}</td>
                        <td>
                            <button class="material-button down-btn" onclick="deactivateProduct(${prod.prodId})">ä¸‹æ¶</button>
                        </td>
                        <td>${prod.rejectReason}</td>
                    `;
                        tbody.appendChild(tr);
                    });
                })
                .catch(err => {
                    console.error("è¼‰å…¥ä¸Šæ¶å•†å“å¤±æ•—ï¼š", err);
                });
        }

        function deactivateProduct(prodId) {
            const confirmed = confirm("ç¢ºå®šè¦ä¸‹æ¶é€™å€‹å•†å“å—ï¼Ÿ");
            if (!confirmed) return;

            fetch("http://localhost:8087/api/ShShop/delist", {
                method: "POST",
                headers: {
                    "Content-Type": "application/x-www-form-urlencoded"
                },
                body: new URLSearchParams({
                    prodId: prodId,
                    action: "deactivate"
                })
            })
                .then(res => res.json())
                .then(res => {
                    if (res.message === "success") {
                        alert("å•†å“å·²ä¸‹æ¶ï¼");
                        loadOnSaleProducts(); // ğŸ” é‡æ–°è¼‰å…¥ä¸Šæ¶ä¸­å•†å“
                    } else {
                        alert("ä¸‹æ¶å¤±æ•—ï¼š" + (res.message || "è«‹ç¨å¾Œå†è©¦"));
                    }
                })
                .catch(err => {
                    console.error("ä¸‹æ¶å¤±æ•—ï¼š", err);
                    alert("ä¼ºæœå™¨éŒ¯èª¤ï¼Œè«‹ç¨å¾Œå†è©¦");
                });

        }
        // resend product for review
        // é‡æ–°é€å¯©å•†å“
        function sendForReview(prodId) {
            const confirmed = confirm("ç¢ºå®šè¦é‡æ–°é€å¯©é€™å€‹å•†å“å—ï¼Ÿ");
            if (!confirmed) return;

            fetch("http://localhost:8087/api/ShShop/sendReview", {
                method: "POST",
                headers: {
                    "Content-Type": "application/x-www-form-urlencoded"
                },
                body: new URLSearchParams({
                    prodId: prodId,
                })
            })
                .then(res => res.json())
                .then(res => {
                    if (res.message === "success") {
                        alert("å•†å“é€å¯©ï¼");
                        loadOnDelistProducts(); // ğŸ” é‡æ–°è¼‰å…¥å·²ä¸‹æ¶ä¸­å•†å“
                    } else {
                        alert("å•†å“é€å¯©å¤±æ•—ï¼š" + (res.message || "è«‹ç¨å¾Œå†è©¦"));
                    }
                })
                .catch(err => {
                    console.error("å•†å“é€å¯©å¤±æ•—ï¼š", err);
                    alert("ä¼ºæœå™¨éŒ¯èª¤ï¼Œè«‹ç¨å¾Œå†è©¦");
                });

        }


        function loadOnDelistProducts() {
            fetch("http://localhost:8087/api/ShShop/myProds", {
                method: "POST",
                headers: {
                    "Content-Type": "application/x-www-form-urlencoded"
                },
                body: new URLSearchParams({ action: "notAvailable" })
            })
                .then(res => res.json())
                .then(res => {
                    if (!res || !res.data || !Array.isArray(res.data)) {
                        console.error("å›å‚³æ ¼å¼éŒ¯èª¤", res);
                        return;
                    }

                    const tbody = document.querySelector("tbody");
                    tbody.innerHTML = "";

                    const onSale = res.data;

                    if (onSale.length === 0) {
                        tbody.innerHTML = "<tr><td colspan='7'>ç›®å‰æ²’æœ‰ä¸‹æ¶çš„å•†å“</td></tr>";
                        return;
                    }

                    onSale.forEach(prod => {
                        const firstImg = prod.picUrls?.[0] || "https://via.placeholder.com/60";
                        const tr = document.createElement("tr");
                        if (prod.rejectReason == null) {
                            prod.rejectReason = "";
                        }
                        tr.innerHTML = `
                        <td><img class="prod-img" src="${firstImg}" alt="å•†å“åœ–ç‰‡" /></td>
                        <td>${prod.prodName}</td>
                        <td>$${prod.prodPrice}</td>
                        <td>${prod.prodCount}</td>
                        <td>${prod.prodDesc}</td>
                        <td>${prod.prodStatusStr}</td>
                        <td>
                            <button class="material-button down-btn" onclick="sendForReview(${prod.prodId})">é‡æ–°é€å¯©</button>
                        </td>
                        <td>${prod.rejectReason}</td>
                    `;
                        tbody.appendChild(tr);
                    });
                })
                .catch(err => {
                    console.error("è¼‰å…¥å·²ä¸‹æ¶å•†å“å¤±æ•—ï¼š", err);
                });
        }
        function loadOnPendingProducts() {
            fetch("http://localhost:8087/api/ShShop/myProds", {
                method: "POST",
                headers: {
                    "Content-Type": "application/x-www-form-urlencoded"
                },
                body: new URLSearchParams({ action: "OnPending" })
            })
                .then(res => res.json())
                .then(res => {
                    if (!res || !res.data || !Array.isArray(res.data)) {
                        console.error("å›å‚³æ ¼å¼éŒ¯èª¤", res);
                        return;
                    }

                    const tbody = document.querySelector("tbody");
                    tbody.innerHTML = "";
                    const onSale = res.data;

                    if (onSale.length === 0) {
                        tbody.innerHTML = "<tr><td colspan='7'>ç›®å‰æ²’æœ‰å¯©æ ¸ä¸­çš„å•†å“</td></tr>";
                        return;
                    }

                    onSale.forEach(prod => {
                        const firstImg = prod.picUrls?.[0] || "https://via.placeholder.com/60";

                        const tr = document.createElement("tr");
                        if (prod.rejectReason == null) {
                            prod.rejectReason = "å¯©æ ¸ä¸­";
                        }
                        tr.innerHTML = `
                        <td><img class="prod-img" src="${firstImg}" alt="å•†å“åœ–ç‰‡" /></td>
                        <td>${prod.prodName}</td>
                        <td>$${prod.prodPrice}</td>
                        <td>${prod.prodCount}</td>
                        <td>${prod.prodDesc}</td>
                        <td>${prod.prodStatusStr}</td>
                        <td>
                          <button type="button" class="material-button edit-btn" onclick="goToEdit(${prod.prodId}, '${prod.prodStatusStr}')">ä¿®æ”¹</button>
                        </td>
                        <td>${prod.rejectReason}</td>
                    `;
                        tbody.appendChild(tr);
                    });
                })
                .catch(err => {
                    console.error("è¼‰å…¥å¯©æ ¸ä¸­å•†å“å¤±æ•—ï¼š", err);
                });
        }
    </script>





</body>

</html>