<!DOCTYPE html>
<html lang="zh-Hant">

<head>
    <meta charset="UTF-8">
    <title>çµå¸³ | MatchMarket</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="./css/checkout.css">

</head>

<body>
    <div class="container">
        <h2>ğŸ›’ çµå¸³</h2>

        <!-- å•†å“è³‡è¨Š -->
        <div class="product-info">
            <img id="productImage" src="https://via.placeholder.com/120" alt="å•†å“åœ–ç‰‡">
            <div class="product-details">
                <div class="product-title">
                    <strong id="productName">å•†å“åç¨±</strong>
                    <span class="price">$<span id="productPrice">0</span></span>
                </div>
                <div>å“ç‰Œï¼š<span id="productBrand">å“ç‰Œå</span></div>
                <label>è³¼è²·æ•¸é‡ <input type="number" id="quantity" value="1" min="1" max="10"></label>
            </div>
            <!-- å•†å“æè¿° -->
            <div class="section">
                <h3>å•†å“æè¿°</h3>
                <div id="productContent">å•†å“å…§å®¹è¼‰å…¥ä¸­...</div>
                <div id="productDesc">å•†å“è©³ç´°èªªæ˜è¼‰å…¥ä¸­...</div>
            </div>
        </div>

        <!-- æ”¶ä»¶è³‡è¨Š -->
        <div class="section">
            <h3>æ”¶ä»¶è³‡è¨Š</h3>
            <label>æ”¶ä»¶äººå§“å
                <input id="receiverName" type="text" placeholder="è«‹è¼¸å…¥çœŸå¯¦å§“å">
            </label>
            <label>æ”¶ä»¶äººæ‰‹æ©Ÿ
                <input id="receiverPhone" type="tel" placeholder="09xxxxxxxx">
            </label>
            <label>é‹é€æ–¹å¼
                <select id="shippingMethod">
                    <option value="0">å®…é…</option>
                    <option value="1">è¶…å•†å–è²¨</option>
                </select>
            </label>

            <!-- è¶…å•†å–è²¨ -->
            <div id="cvsGroup" class="cvs-select-group">
                <label>é¸æ“‡è¶…å•†
                    <select id="cvsType">
                        <option value="FAMIC2C">å…¨å®¶</option>
                        <option value="UNIMARTC2C">7-11</option>
                        <option value="OKMARTC2C">OK</option>
                        <option value="HILIFEC2C">èŠçˆ¾å¯Œ</option>
                    </select>
                    <button id="selectCvsBtn" type="button" onclick="selectStore()">é¸æ“‡è¶…å•†é–€å¸‚</button>
                </label>

                <!-- âœ… è¶…å•†è³‡è¨Šé¡¯ç¤ºå€ -->
                <div id="storeInfo" style="margin-top: 10px; display: none; padding: 10px; border: 1px solid #ccc;">
                    <div><strong>é–€å¸‚åç¨±ï¼š</strong><span id="storeName">-</span></div>
                    <div><strong>é–€å¸‚ç·¨è™Ÿï¼š</strong><span id="storeId">-</span></div>
                    <div><strong>é–€å¸‚åœ°å€ï¼š</strong><span id="storeAddress">-</span></div>
                    <div><strong>é–€å¸‚é›»è©±ï¼š</strong><span id="storeTelephone">-</span></div>
                </div>
            </div>

            <!-- å®…é… -->
            <div id="homeGroup">
                <label>æ”¶ä»¶äººéƒµéå€è™Ÿ
                    <input id="receiverZip" type="text" placeholder="ä¾‹å¦‚ï¼š114">
                </label>
                <label>æ”¶ä»¶äººåœ°å€
                    <textarea id="receiverAddress" rows="2" placeholder="è«‹å¡«å¯«å®Œæ•´åœ°å€"></textarea>
                </label>
            </div>
        </div>

        <!-- ä»˜æ¬¾æ–¹å¼ -->
        <div class="section">
            <h3>ä»˜æ¬¾æ–¹å¼</h3>
            <select id="paymentMethod">
                <option value="0">è²¨åˆ°ä»˜æ¬¾</option>
                <option value="1">ç·šä¸Šä»˜æ¬¾</option>
            </select>
        </div>

        <!-- å‚™è¨» -->
        <div class="section">
            <h3>è¨‚å–®å‚™è¨»</h3>
            <textarea id="orderNote" rows="3" placeholder="æœ‰ä»»ä½•å‚™è¨»å¯ä»¥å¡«å¯«..."></textarea>
        </div>

        <!-- è¨‚å–®æ‘˜è¦ -->
        <div class="section">
            <h3>è¨‚å–®æ‘˜è¦</h3>
            <div class="summary">
                <div><span>å•†å“å°è¨ˆ</span><span>$<span id="subtotal">0</span></span></div>
                <div><span>é‹è²»</span><span>$<span id="shippingFee">60</span></span></div>
                <div><span>å¹³å°æ‰‹çºŒè²»</span><span>$<span id="platformFee">0</span></span></div>
                <div class="total"><span>ç¸½é‡‘é¡</span><span>$<span id="totalAmount">0</span></span></div>
            </div>
        </div>

        <button class="btn" onclick="submitOrder()">ç¢ºèªä¸‹å–®</button>
    </div>


    <!-- ğŸ”¥ ç‡ˆç®± -->
    <div id="confirmModal" class="modal">
        <div class="modal-content">
            <h3>è¨‚å–®ç¢ºèª</h3>
            <div id="confirmDetails"></div>
            <div class="modal-actions">
                <button onclick="confirmSubmit()">ç¢ºèªé€å‡º</button>
                <button onclick="closeModal()">å–æ¶ˆ</button>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', async () => {
            const prodId = localStorage.getItem('checkoutProdId');
            const buyQty = localStorage.getItem('checkoutBuyQty') || 1;

            if (!prodId) {
                alert('âŒ æ‰¾ä¸åˆ°å•†å“ï¼Œè«‹é‡æ–°é¸æ“‡å•†å“');
                window.location.href = 'select_page.html';
                return;
            }

            const prod = await fetch(`/api/ShShop/getProd?id=${prodId}`)
                .then(r => r.json()).then(j => j.data);
            document.getElementById('productName').textContent = prod.prodName;
            document.getElementById('productBrand').textContent = prod.prodBrand;
            document.getElementById('productPrice').textContent = prod.prodPrice;
            document.getElementById('productContent').textContent = prod.prodContent || "";
            document.getElementById('productDesc').textContent = prod.prodDesc || "";
            document.getElementById('productImage').src = prod.picUrls?.[0] || 'https://via.placeholder.com/120';

            const qtyInput = document.getElementById('quantity');
            qtyInput.value = buyQty;
            qtyInput.max = prod.prodCount;
            qtyInput.addEventListener('input', calcSummary);
            calcSummary();

            const shippingSelect = document.getElementById('shippingMethod');
            const cvsGroup = document.getElementById('cvsGroup');
            const homeGroup = document.getElementById('homeGroup');
            const paymentSelect = document.getElementById('paymentMethod');

            shippingSelect.addEventListener('change', () => {
                const shipM = +shippingSelect.value;
                if (shipM === 0) {
                    paymentSelect.querySelector('option[value="0"]').disabled = true;
                    if (paymentSelect.value === "0") paymentSelect.value = "1";
                    cvsGroup.style.display = 'none';
                    homeGroup.style.display = 'block';
                } else {
                    paymentSelect.querySelector('option[value="0"]').disabled = false;
                    cvsGroup.style.display = 'block';
                    homeGroup.style.display = 'none';
                }
            });
            shippingSelect.dispatchEvent(new Event('change'));
        });

        function submitOrder() {
            const prodId = localStorage.getItem('checkoutProdId');
            if (!prodId) { alert('æœªé¸æ“‡å•†å“'); return; }

            const qty = +document.getElementById('quantity').value;
            const shipM = +document.getElementById('shippingMethod').value;
            const payM = +document.getElementById('paymentMethod').value;
            const note = document.getElementById('orderNote').value.trim();
            const recvName = document.getElementById('receiverName').value.trim();
            const recvPhone = document.getElementById('receiverPhone').value.trim();
            const recvZip = document.getElementById('receiverZip').value.trim();
            const recvAddr = document.getElementById('receiverAddress').value.trim();

            if (!recvName) { alert('è«‹å¡«å¯«æ”¶ä»¶äººå§“å'); return; }
            if (!recvPhone) { alert('è«‹å¡«å¯«æ”¶ä»¶äººæ‰‹æ©Ÿ'); return; }
            if (shipM === 0 && (!recvZip || !recvAddr)) {
                alert('è«‹å¡«å¯«æ”¶ä»¶äººéƒµéå€è™Ÿå’Œåœ°å€'); return;
            }

            const processData = {
                prodId: prodId,
                prodName: document.getElementById('productName').textContent,
                prodPrice: +document.getElementById('productPrice').textContent,
                sellerUserId: 1,
                productQuantity: qty,
                shippingMethod: shipM,
                paymentMethod: payM,
                shippingAddress: `${recvZip} ${recvAddr}`,
                receiverZip: recvZip,
                receiverAddress: recvAddr,
                receiverName: recvName,
                receiverPhone: recvPhone,
                orderNote: note,
                totalAmount: calcTotal(+document.getElementById('productPrice').textContent, qty),

                // â¬‡â¬‡â¬‡ é–€å¸‚è³‡è¨Šå¾ localStorage è®€
                cvsType: localStorage.getItem('cvsType') || '',
                storeId: localStorage.getItem('storeId') || '',
                storeName: localStorage.getItem('storeName') || '',
                storeAddress: localStorage.getItem('storeAddress') || '',
                storeTelephone: localStorage.getItem('storeTelephone') || ''
            };

            // Save to orderData (è‡ªå·±è³‡æ–™åº«ç”¨)
            const orderData = {
                prodId: processData.prodId,
                sellerUserId: 1,
                productPrice: processData.prodPrice,
                productQuantity: processData.productQuantity,
                platformFee: Math.ceil(processData.prodPrice * processData.productQuantity * 0.01),
                shippingFee: 60,
                shippingAddress: processData.shippingAddress,
                shippingMethod: processData.shippingMethod,
                paymentMethod: processData.paymentMethod,
                orderNote: processData.orderNote,
                totalAmount: processData.totalAmount,
            };
            localStorage.setItem('orderData', JSON.stringify(orderData));

            showConfirmModal(processData);
        }

        function calcSummary() {
            const price = +document.getElementById('productPrice').textContent;
            const qty = +document.getElementById('quantity').value;
            const subtotal = price * qty;
            const ship = 60;
            const fee = Math.ceil(subtotal * 0.01);
            const total = subtotal + ship + fee;
            document.getElementById('subtotal').textContent = subtotal;
            document.getElementById('shippingFee').textContent = ship;
            document.getElementById('platformFee').textContent = fee;
            document.getElementById('totalAmount').textContent = total;
        }

        function calcTotal(price, qty) {
            const subtotal = price * qty;
            const ship = 60;
            const fee = Math.ceil(subtotal * 0.01);
            return subtotal + ship + fee;
        }

        function showConfirmModal(data) {
            const modal = document.getElementById('confirmModal');
            const details = document.getElementById('confirmDetails');
            details.innerHTML = `
            <p>å•†å“åç¨±ï¼š${data.prodName}</p>
            <p>æ•¸é‡ï¼š${data.productQuantity}</p>
            <p>é‹é€æ–¹å¼ï¼š${data.shippingMethod === 0 ? 'å®…é…' : 'è¶…å•†å–è²¨'}</p>
            <p>ä»˜æ¬¾æ–¹å¼ï¼š${data.paymentMethod === 0 ? 'è²¨åˆ°ä»˜æ¬¾' : 'ç·šä¸Šä»˜æ¬¾'}</p>
            <p>æ”¶ä»¶äººï¼š${data.receiverName}</p>
            <p>æ‰‹æ©Ÿï¼š${data.receiverPhone}</p>
            <p>åœ°å€ï¼š${data.shippingAddress}</p>
            <p>è¨‚å–®å‚™è¨»ï¼š${data.orderNote || 'ç„¡'}</p>
            <hr>
            <p><strong>ç¸½é‡‘é¡ï¼š$${data.totalAmount}</strong></p>
        `;
            modal.style.display = 'block';
            window._orderProcessData = data;
        }

        function closeModal() {
            document.getElementById('confirmModal').style.display = 'none';
        }

        function confirmSubmit() {
            const data = window._orderProcessData;
            if (!data) return;
            localStorage.setItem('orderProcessData', JSON.stringify(data));
            window.location.href = 'order_process.html';
            localStorage.removeItem('checkoutProdId');
            localStorage.removeItem('checkoutBuyQty');
            localStorage.removeItem('LogisticsSubType');
            localStorage.removeItem('storeId');
            localStorage.removeItem('storeName');
            localStorage.removeItem('storeAddress');
            localStorage.removeItem('storeTelephone');
        }

        // ====================== è¶…å•†é¸æ“‡ ========================
        function selectStore() {
            const cvsType = document.getElementById('cvsType').value;

            if (!cvsType) {
                alert("è«‹é¸æ“‡è¶…å•†å–è²¨æ–¹å¼");
                return;
            }

            const url = `/ecpay/logisticsMap?cvsType=${cvsType}`;
            const windowOptions = 'width=800,height=600,scrollbars=yes,resizable=yes';
            const logisticsWindow = window.open(url, 'LogisticsMap', windowOptions);

            const handleMessage = (event) => {
                if (event.origin !== window.location.origin) return;

                const data = event.data;
                if (data && data.storeId && data.storeName && data.storeAddress) {
                    console.log('ğŸ‘‰ æ”¶åˆ°é–€å¸‚è³‡æ–™ï¼š', data);

                    // é¡¯ç¤ºåœ¨åœ°å€æ¬„
                    document.getElementById('receiverAddress').value =
                        `${data.storeName}ï¼ˆ${data.storeId}ï¼‰\n${data.storeAddress}\n${data.storeTelephone || ''}`;

                    // é¡¯ç¤ºåœ¨è¶…å•†è³‡è¨Šå€å¡Š
                    document.getElementById('storeName').textContent = data.storeName;
                    document.getElementById('storeId').textContent = data.storeId;
                    document.getElementById('storeAddress').textContent = data.storeAddress;
                    document.getElementById('storeTelephone').textContent = data.storeTelephone || 'ç„¡';
                    document.getElementById('storeInfo').style.display = 'block';

                    // æ›´æ–°åˆ° orderProcessData
                    localStorage.setItem('cvsType', cvsType);
                    localStorage.setItem('storeId', data.storeId);
                    localStorage.setItem('storeName', data.storeName);
                    localStorage.setItem('storeAddress', data.storeAddress);
                    localStorage.setItem('storeTelephone', data.storeTelephone || '');
                    // é—œé–‰åœ°åœ–è¦–çª—
                    logisticsWindow.close();

                    // ä¸€æ¬¡æ€§ç›£è½ â†’ ç”¨å®Œç§»é™¤
                    window.removeEventListener('message', handleMessage);
                }
            };

            window.addEventListener('message', handleMessage);
        }
    </script>


</body>

</html>