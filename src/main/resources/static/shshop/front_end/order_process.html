<!DOCTYPE html>
<html lang="zh-Hant">

<head>
    <meta charset="UTF-8">
    <title>ç‰©æµè¨‚å–®è™•ç†ä¸­ | MatchMarket</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" />
    <style>
        * {
            box-sizing: border-box;
        }

        body {
            font-family: "Noto Sans TC", sans-serif;
            display: flex;
            align-items: center;
            justify-content: center;
            height: 100vh;
            margin: 0;

            background: linear-gradient(185deg,
                    #DCFF61 0%,
                    #DCFF61 55%,
                    #2EC4B6 55%,
                    #2EC4B6 100%);
            overflow: hidden;
        }

        .container {
            background-color: white;
            padding: 40px;
            border-radius: 16px;
            box-shadow: 0 0 15px rgba(0, 0, 0, 0.1);
            text-align: center;
            max-width: 420px;
            width: 90%;
        }

        h1 {
            color: #26A79A;
            margin-bottom: 16px;
        }

        .loading {
            font-size: 48px;
            margin: 16px 0;
            color: #2EC4B6;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% {
                transform: rotate(0);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        .info {
            margin: 20px 0;
            line-height: 1.8;
            font-size: 16px;
            text-align: left;
        }

        .error {
            color: red;
            font-weight: bold;
            margin-top: 20px;
        }

        .btn {
            display: inline-block;
            background-color: #2EC4B6;
            color: white;
            padding: 10px 20px;
            border-radius: 8px;
            text-decoration: none;
            margin-top: 10px;
            transition: background-color 0.3s;
        }

        .btn:hover {
            background-color: #26A79A;
        }
    </style>
</head>

<body>
    <div class="container">
        <div class="loading">
            <i class="fa-solid fa-rotate"></i>
        </div>
        <h1>è¨‚å–®</h1>
        <div class="info">
            <div class="logistics-info">
                <h2>ğŸšš ç‰©æµè³‡è¨Š</h2>
                <div id="logisticsResult"></div>
            </div>
            <div>è¨‚å–®ç·¨è™Ÿï¼š<span id="orderId">--</span></div>
            <div>æ”¶ä»¶äººï¼š<span id="receiver">--</span></div>
            <div>ç‰©æµæ–¹å¼ï¼š<span id="logistics">--</span></div>
        </div>
        <div class="error" id="errorMsg"></div>
        <a href="order_master.html" class="btn">æŸ¥çœ‹è¨‚å–®</a>
        <a href="select_page.html" class="btn">å›é¦–é </a>
        <button id="payButton" class="btn" style="display: none;">ç«‹å³ä»˜æ¬¾</button>
    </div>


    <script>



    </script>
    <script>
        document.addEventListener('DOMContentLoaded', async () => {
            const orderData = JSON.parse(localStorage.getItem('orderData'));
            const processData = JSON.parse(localStorage.getItem('orderProcessData'));

            // if (!orderData || !processData) {
            //     alert('âŒ æ‰¾ä¸åˆ°è¨‚å–®è³‡æ–™æˆ–ç‰©æµè³‡æ–™ï¼Œè«‹é‡æ–°ä¸‹å–®');
            //     window.location.href = 'checkout.html';
            //     return;
            // }

            try {
                /* ================= âœ” å»ºç«‹è¨‚å–® ================= */
                const createRes = await fetch('/api/shorder/create', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(orderData)
                });

                const createResult = await createRes.json();

                if (createResult.status !== 200) {
                    document.getElementById('errorMsg').textContent =
                        'âŒ å»ºç«‹è¨‚å–®å¤±æ•—ï¼š' + createResult.message;
                    return;
                }

                const orderId = createResult.data.shOrderId;
                const totalAmount = createResult.data.totalAmount;

                console.log('âœ… è¨‚å–®å»ºç«‹æˆåŠŸ', orderId, totalAmount);

                // âœ… å­˜å…¥ processData
                processData.orderId = orderId;
                processData.totalAmount = totalAmount;
                localStorage.setItem('orderProcessData', JSON.stringify(processData));

                // âœ… ç•«é¢é¡¯ç¤º
                document.getElementById('orderId').textContent = orderId;
                document.getElementById('receiver').textContent = processData.receiverName;
                document.getElementById('logistics').textContent =
                    processData.shippingMethod === 0 ? 'å®…é…' : 'è¶…å•†å–è²¨';

                /* ================= âœ” å»ºç«‹ç‰©æµ ================= */
                const logisticsUrl =
                    processData.shippingMethod === 0
                        ? '/ecpay/logisticsPost'
                        : '/ecpay/logisticsCvs';

                const logisticsParams =
                    processData.shippingMethod === 0
                        ? {
                            orderId: orderId,
                            totalAmount: totalAmount,
                            receiverName: processData.receiverName,
                            receiverPhone: processData.receiverPhone,
                            ReceiverZipCode: processData.receiverZip,
                            ReceiverAddress: processData.receiverAddress,
                            remarks: processData.orderNote || ''
                        }
                        : {
                            orderId: orderId,
                            totalAmount: totalAmount,
                            receiverName: processData.receiverName,
                            receiverPhone: processData.receiverPhone,
                            cvsType: processData.cvsType,
                            storeId: processData.storeId,
                            storeName: processData.storeName,
                            storeAddress: processData.storeAddress,
                            remarks: processData.orderNote || '',
                            isCod: processData.paymentMethod === 0
                        };

                const resp = await fetch(logisticsUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                    body: new URLSearchParams(logisticsParams)
                });

                const logisticsResult = await resp.text();

                console.log('ğŸšš ç‰©æµçµæœï¼š', logisticsResult);

                // ================= âœ” ç‰©æµçµæœè§£æ & é¡¯ç¤º =================
                const dataStr = logisticsResult.split('|')[1] || '';
                const params = new URLSearchParams(dataStr);

                const resultObj = {};
                params.forEach((v, k) => resultObj[k] = v);

                const logisticsDiv = document.createElement('div');
                logisticsDiv.style.cssText = 'margin-top:20px; padding:10px; background:#f0f0f0; border-radius:8px;';

                logisticsDiv.innerHTML = `
                <h3>ğŸ“¦ ç‰©æµè³‡è¨Š</h3>
                <p><strong>ç‰©æµç‹€æ…‹ï¼š</strong>${resultObj.RtnMsg || 'ç„¡'}ï¼ˆä»£ç¢¼ ${resultObj.RtnCode || '-'}ï¼‰</p>
                <p><strong>è¨‚å–®ç·¨è™Ÿï¼š</strong>${resultObj.MerchantTradeNo || '-'}</p>
                <p><strong>ç‰©æµé¡å‹ï¼š</strong>${resultObj.LogisticsType || '-'} - ${resultObj.LogisticsSubType || '-'}</p>
                <p><strong>æ”¶ä»¶äººï¼š</strong>${resultObj.ReceiverName || '-'}</p>
                <p><strong>æ‰‹æ©Ÿï¼š</strong>${resultObj.ReceiverCellPhone || '-'}</p>
                <p><strong>åœ°å€ï¼š</strong>${resultObj.ReceiverAddress || '-'}</p>
                <p><strong>é‡‘é¡ï¼š</strong>${resultObj.GoodsAmount || '-'}</p>
                <p><strong>æ›´æ–°æ™‚é–“ï¼š</strong>${resultObj.UpdateStatusDate || '-'}</p>
                <p><strong>ç‰©æµå–®è™Ÿï¼š</strong>${resultObj.AllPayLogisticsID || '-'}</p>
            `;

                document.body.appendChild(logisticsDiv);

            } catch (err) {
                document.getElementById('errorMsg').textContent =
                    'âŒ ç™¼ç”ŸéŒ¯èª¤ï¼š' + err.message;
                console.error(err);
            }

            const payButton = document.getElementById('payButton');

            if (processData.paymentMethod === 1) {
                payButton.style.display = 'inline-block'; // é¡¯ç¤ºä»˜æ¬¾æŒ‰éˆ•
            }

            payButton.addEventListener('click', async () => {
                try {
                    const res = await fetch('/ecpay/checkout', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                        body: new URLSearchParams({
                            orderId: processData.orderId,
                            totalAmount: processData.totalAmount,
                            receiverName: processData.receiverName,
                            receiverPhone: processData.receiverPhoneol
                        })
                    });

                    const html = await res.text();

                    // âœ”ï¸ å°‡è¿”å›çš„ä»˜æ¬¾è¡¨å–®æ’å…¥ä¸¦è‡ªå‹•æäº¤
                    const payFormDiv = document.createElement('div');
                    payFormDiv.innerHTML = html;
                    document.body.appendChild(payFormDiv);

                    const payForm = payFormDiv.querySelector('form');
                    if (payForm) {
                        payForm.submit();
                    } else {
                        alert('âŒ é‡‘æµè¡¨å–®ç”¢ç”Ÿå¤±æ•—');
                    }

                } catch (err) {
                    console.error('âŒ é‡‘æµéŒ¯èª¤', err);
                    alert('âŒ ç™¼ç”ŸéŒ¯èª¤ï¼š' + err.message);
                }
            });


        });
    </script>


</body>

</html>