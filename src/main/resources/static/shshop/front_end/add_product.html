<!DOCTYPE html>
<html lang="zh-Hant">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>å•†å“ä¸Šæ¶ï½œMatchMarket</title>
  <link rel="stylesheet" href="css/header.css"/>
  <link rel="stylesheet" href="css/add_product.css" />
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet" />

</head>

<body>

    <header class="header">
        <!-- Logo å€ -->
        <div class="header__logo">
            <a href="/">
                <img src="../../img/logoText.png" alt="Logo" />
            </a>
        </div>

        <!-- å°è¦½åˆ— -->
        <nav class="header__nav">
            <ul class="header__list">
                <li class="header__item"><a href="#">é…å°</a></li>
                <li class="header__item"><a href="#">èŠå¤©å®¤</a></li>
                <li class="header__item"><a href="#">æ´»å‹•</a></li>
                <li class="header__item"><a href="#">è¨è«–å€</a></li>

                <!-- ğŸ”½ MatchMarket Dropdown -->
                <li class="header__item dropdown">
                    <a href="select_page.html">MatchMarket</a>
                    <ul class="dropdown-menu">
                        <li><a href="select_page.html">çœ‹ä¸€ä¸‹å•†å“</a></li>
                        <li class="dropdown-submenu">
                            <a href="product_manager.html">My MatchMarket</a>
                            <ul class="dropdown-menu">
                                <li><a href="add_product.html">ä¸Šæ¶å•†å“</a></li>
                                <li><a href="#">å·²è³¼è³£å•†å“</a></li>
                            </ul>
                        </li>
                    </ul>
                </li>

                <li class="header__item"><a href="#">æœƒå“¡å°ˆå€</a></li>
            </ul>
        </nav>

        <!-- ä½¿ç”¨è€…åœ–ç¤º -->
        <div class="header__user">
            <i class="fa-solid fa-user"></i>
        </div>
    </header>


<main class="form-wrapper">
  <h1>ä¸Šæ¶å•†å“</h1>

  <form class="form-layout" method="post" enctype="multipart/form-data">

    <!-- âœ… åŸºæœ¬è³‡æ–™ -->
    <section class="form-section">
      <div class="form-label-col"><p>åŸºæœ¬è³‡è¨Š</p></div>
      <div class="form-input-col">

        <div class="form-group">
          <label>å•†å“åç¨±ï¼š</label>
          <input type="text" name="prodName" placeholder="è«‹è¼¸å…¥å•†å“åç¨±">
          <div class="error-msg" id="prodNameError"></div>
        </div>

        <div class="form-group">
          <label>å“ç‰Œï¼š</label>
          <input type="text" name="prodBrand" placeholder="è«‹è¼¸å…¥å“ç‰Œåç¨±">
          <div class="error-msg" id="prodBrandError"></div>
        </div>

        <div class="form-group">
          <label>å•†å“åˆ†é¡ï¼š</label>
          <select name="prodTypeId">
            <option value="">è«‹é¸æ“‡åˆ†é¡</option>
          </select>
          <div class="error-msg" id="prodTypeIdError"></div>
        </div>

        <div class="form-row -number">
          <div class="form-group">
            <label>åƒ¹æ ¼ï¼š</label>
            <input type="number" name="prodPrice" placeholder="å–®ä½ï¼šå…ƒ">
            <div class="error-msg" id="prodPriceError"></div>
          </div>

          <div class="form-group">
            <label>æ•¸é‡ï¼š</label>
            <input type="number" name="prodCount" value="1" placeholder="é è¨­ç‚º 1">
            <div class="error-msg" id="prodCountError"></div>
          </div>
        </div>

        <div class="form-group">
          <label>ç°¡è¦æè¿°ï¼š</label>
          <textarea name="prodContent" rows="4" placeholder="è«‹è¼¸å…¥å•†å“ç°¡ä»‹..."></textarea>
          <div class="error-msg" id="prodContentError"></div>
        </div>
      </div>
    </section>

    <!-- âœ… åœ–ç‰‡ -->
    <section class="form-section">
      <div class="form-label-col"><p>åœ–ç‰‡</p></div>
      <div class="form-input-col">
        <div class="form-group">
          <label>å•†å“åœ–ç‰‡ï¼ˆæœ€å¤š 5 å¼µï¼Œå»ºè­°å°ºå¯¸ï¼š800x800ï¼‰ï¼š</label>
          <div class="drop-zone" id="dropZone">æ‹–æ›³åœ–ç‰‡åˆ°æ­¤è™•ï¼Œæˆ–é»æ“Šé¸æ“‡</div>
          <input type="file" id="prodImageInput" accept="image/*" multiple hidden>
          <div class="preview-container" id="previewContainer"></div>
        </div>
      </div>
    </section>

    <!-- âœ… ä»‹ç´¹ -->
    <section class="form-section">
      <div class="form-label-col"><p>å•†å“èªªæ˜</p></div>
      <div class="form-input-col">
        <label>å•†å“ç‹€æ³èªªæ˜ï¼š</label>
        <textarea name="prodStatusDesc" rows="5" placeholder="ä¾‹å¦‚ï¼šäºŒæ‰‹è‰¯å“ã€ä¹æˆæ–°ã€æœªæ‹†å°ç­‰..."></textarea>
        <div class="error-msg" id="prodStatusDescError"></div>
      </div>
    </section>

    <!-- âœ… æŒ‰éˆ• -->
    <div class="button-row">
      <input type="hidden" name="action" value="createProd" />
      <button type="reset" class="discard">é‡è¨­</button>
      <button type="submit" class="save">é€å‡º</button>
    </div>

  </form>
</main>

  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>
<script src="js/shshopType.js"></script>

<script>
  document.addEventListener("DOMContentLoaded", function () {
    const form = document.querySelector(".form-layout");
    const dropZone = document.getElementById("dropZone");
    const fileInput = document.getElementById("prodImageInput");
    const previewContainer = document.getElementById("previewContainer");
    let imageFiles = [];

    // === æ‹–æ›³èˆ‡é»é¸åœ–ç‰‡ä¸Šå‚³ ===
    dropZone.addEventListener("click", () => fileInput.click());

    dropZone.addEventListener("dragover", e => {
      e.preventDefault();
      dropZone.style.backgroundColor = "#e8f4fc";
    });

    dropZone.addEventListener("dragleave", () => {
      dropZone.style.backgroundColor = "#f9f9f9";
    });

    dropZone.addEventListener("drop", e => {
      e.preventDefault();
      dropZone.style.backgroundColor = "#f9f9f9";
      handleFiles(e.dataTransfer.files);
    });

    fileInput.addEventListener("change", () => {
      handleFiles(fileInput.files);
    });

    function handleFiles(files) {
      const newFiles = Array.from(files);
      if (imageFiles.length + newFiles.length > 5) {
        alert("æœ€å¤šåªèƒ½ä¸Šå‚³ 5 å¼µåœ–ç‰‡ï¼");
        return;
      }

      newFiles.forEach(file => {
        imageFiles.push(file);
        renderPreview(file);
      });
    }

    function renderPreview(file) {
      const reader = new FileReader();
      reader.onload = function (e) {
        const box = document.createElement("div");
        box.classList.add("preview-box");

        const img = document.createElement("img");
        img.src = e.target.result;

        const deleteBtn = document.createElement("button");
        deleteBtn.classList.add("delete-btn");
        deleteBtn.innerText = "Ã—";
        deleteBtn.addEventListener("click", () => {
          previewContainer.removeChild(box);
          imageFiles = imageFiles.filter(f => f !== file);
        });

        box.appendChild(img);
        box.appendChild(deleteBtn);
        previewContainer.appendChild(box);
      };
      reader.readAsDataURL(file);
    }

    // === æ¬„ä½ onblur å³æ™‚é©—è­‰ ===
    const requiredFields = [
      { name: "prodName", msg: "å•†å“åç¨±ç‚ºå¿…å¡«" },
      { name: "prodBrand", msg: "å“ç‰Œç‚ºå¿…å¡«" },
      { name: "prodTypeId", msg: "è«‹é¸æ“‡å•†å“åˆ†é¡" },
      { name: "prodPrice", msg: "è«‹è¼¸å…¥åƒ¹æ ¼" },
      { name: "prodCount", msg: "è«‹è¼¸å…¥æ•¸é‡" },
      { name: "prodContent", msg: "è«‹å¡«å¯«ç°¡è¦æè¿°" },
      { name: "prodStatusDesc", msg: "è«‹å¡«å¯«å•†å“èªªæ˜" }
    ];

    requiredFields.forEach(field => {
      const input = form.querySelector(`[name="${field.name}"]`);
      if (input) {
        input.addEventListener("blur", () => {
          const errorBox = document.getElementById(field.name + "Error");
          if (input.value.trim() === "") {
            errorBox.textContent = field.msg;
          } else {
            errorBox.textContent = "";
          }
        });
      }
    });

    // === è¡¨å–®é€å‡º ===
    form.addEventListener("submit", function (e) {
      e.preventDefault();

      // æ¸…ç©ºéŒ¯èª¤è¨Šæ¯
      document.querySelectorAll(".error-msg").forEach(el => el.innerText = "");

      const formData = new FormData(form);
      imageFiles.forEach(file => formData.append("prodImage", file));

      fetch("http://localhost:8087/api/ShShop/addNewProd", {
        method: "POST",
        body: formData
      })
        .then(response => response.json().then(data => ({ status: response.status, body: data })))
        .then(({ status, body }) => {
          if (body.message === "success") {
            const prodId = body.data?.prodId;
            if (prodId) {
              window.location.href = `/ShShop/front_end/product_page.html?id=${prodId}`;
            } else {
              alert("å•†å“ä¸Šå‚³æˆåŠŸï¼Œä½†æ‰¾ä¸åˆ°å•†å“ç·¨è™Ÿï¼");
            }
          } else if (status === 400 && body.message === "validation_failed") {
            const errors = body.errors || {};
            for (const field in errors) {
              const errBox = document.querySelector(`#${field}Error`);
              if (errBox) {
                errBox.innerText = translateError(errors[field]);
              }
            }
          } else {
            alert("ç™¼ç”ŸæœªçŸ¥éŒ¯èª¤ï¼š" + (body.message || "è«‹ç¨å¾Œå†è©¦"));
          }
        })
        .catch(error => {
          alert("å•†å“ä¸Šå‚³å¤±æ•—ï¼");
          console.error(error);
        });
    });

    // === éŒ¯èª¤è¨Šæ¯ç¿»è­¯è¡¨ ===
    function translateError(msg) {
      const translations = {
        "must not be blank": "æ­¤æ¬„ä½ä¸å¯ç‚ºç©ºç™½",
        "must not be null": "æ­¤æ¬„ä½ç‚ºå¿…å¡«",
        "must be greater than or equal to 1": "æ•¸å€¼è‡³å°‘ç‚º 1",
        "must be a number": "è«‹è¼¸å…¥æ•¸å­—",
        "validation_failed": "è«‹æª¢æŸ¥æ¬„ä½å…§å®¹æ˜¯å¦æ­£ç¢º"
      };

      for (const key in translations) {
        if (msg.includes(key)) {
          return translations[key];
        }
      }

      return msg; // fallback to åŸå§‹è¨Šæ¯
    }
  });
</script>

</body>

</html>